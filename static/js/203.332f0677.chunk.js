!function(){"use strict";var e={1203:function(e,t,r){var n={};r.r(n),r.d(n,{formatFiles:function(){return P},loadData:function(){return q},loadPreflight:function(){return B}});var a={};r.r(a),r.d(a,{formatFiles:function(){return K},loadData:function(){return J},loadPreflight:function(){return Y}});var s={};r.r(s),r.d(s,{extractFeatures:function(){return V},formatFiles:function(){return H},loadData:function(){return $},loadPreflight:function(){return Q}});var o={};r.r(o),r.d(o,{changed:function(){return oe},compute:function(){return ce},fetchAnnotations:function(){return ge},fetchBlock:function(){return be},fetchBlockLevels:function(){return _e},fetchCountMatrix:function(){return he},fetchGeneTypes:function(){return ye},fetchGenes:function(){return ve},process_and_cache:function(){return ie},results:function(){return le},serialize:function(){return fe},unserialize:function(){return me}});var u={};r.r(u),r.d(u,{changed:function(){return Oe},compute:function(){return Ne},fetchDiscards:function(){return Fe},fetchFilteredBlock:function(){return Pe},fetchFilteredMatrix:function(){return ze},fetchSums:function(){return Ce},results:function(){return Ae},serialize:function(){return Ze},unserialize:function(){return Re}});var i={};r.r(i),r.d(i,{changed:function(){return Be},compute:function(){return Ke},fetchExpression:function(){return He},fetchNormalizedMatrix:function(){return Je},results:function(){return Le},serialize:function(){return We},unserialize:function(){return Ye}});var c={};r.r(c),r.d(c,{changed:function(){return Qe},compute:function(){return $e},fetchResiduals:function(){return ot},fetchSortedResiduals:function(){return st},results:function(){return tt},serialize:function(){return rt},unserialize:function(){return at}});var l={};r.r(l),r.d(l,{changed:function(){return ct},compute:function(){return ft},fetchPCs:function(){return vt},results:function(){return pt},serialize:function(){return mt},unserialize:function(){return ht}});var f={};r.r(f),r.d(f,{changed:function(){return bt},compute:function(){return wt},fetchIndex:function(){return Gt},rawCompute:function(){return _t},results:function(){return St},serialize:function(){return kt},unserialize:function(){return xt}});var p={};r.r(p),r.d(p,{changed:function(){return Et},compute:function(){return Tt},fetchClustersAsWasmArray:function(){return Mt},results:function(){return At},serialize:function(){return Zt},unserialize:function(){return jt},valid:function(){return Nt}});var m={};r.r(m),r.d(m,{changed:function(){return Ft},compute:function(){return It},fetchClustersAsWasmArray:function(){return Pt},results:function(){return Bt},serialize:function(){return qt},unserialize:function(){return Lt},valid:function(){return zt}});var d={};r.r(d),r.d(d,{changed:function(){return Yt},compute:function(){return Jt},fetchClustersAsWasmArray:function(){return Qt},results:function(){return Ht},serialize:function(){return Vt},unserialize:function(){return Xt}});var h={};r.r(h),r.d(h,{animate:function(){return vr},changed:function(){return ur},compute:function(){return cr},initialize:function(){return or},results:function(){return pr},serialize:function(){return mr},unserialize:function(){return hr}});var v={};r.r(v),r.d(v,{animate:function(){return Mr},changed:function(){return wr},compute:function(){return kr},initialize:function(){return _r},results:function(){return Dr},serialize:function(){return Or},unserialize:function(){return Nr}});var y={};r.r(y),r.d(y,{changed:function(){return Cr},compute:function(){return Fr},fetchGroupMeans:function(){return Wr},fetchGroupResults:function(){return Kr},numberOfGroups:function(){return Lr},results:function(){return zr},serialize:function(){return Pr},unserialize:function(){return qr}});var g={};r.r(g),r.d(g,{changed:function(){return $r},compute:function(){return pn},results:function(){return mn},serialize:function(){return hn},unserialize:function(){return yn}});var b={};r.r(b),r.d(b,{addSelection:function(){return On},changed:function(){return _n},compute:function(){return wn},fetchResults:function(){return Nn},removeSelection:function(){return En},results:function(){return Sn},serialize:function(){return kn},unserialize:function(){return Dn}});var _=r(5861),w=r(7757),S=r.n(w),k=r(9451),x=r(1413),G=r(9062),D=r(7762),O=r(3324),E=r(6737);function N(e,t){if(t)for(var r=0,n=Object.keys(e);r<n.length;r++){var a=n[r];e[a]=e[a].slice()}}function M(e){return e||"view"}function T(e,t){return e instanceof E.PQ?"view"==t?e.view():t?e.slice():e.array():!0===t?e.slice():e}function A(e){void 0!==e&&null!==e&&e.free()}function Z(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"buffer",a=!0;if(n in r){var s=r[n];s.size!=e||s.constructor.className!=t?s.free():a=!1}if(a)switch(t){case"Uint8Array":r[n]=k.TS(e);break;case"Int32Array":r[n]=k.Wf(e);break;case"Float64Array":r[n]=k.RJ(e);break;default:throw"allocating '"+t+"' not yet supported"}return r[n]}function U(e,t){if(Array.isArray(e)){var r,n=(0,D.Z)(e);try{for(n.s();!(r=n.n()).done;){U(r.value,t)}}catch(u){n.e(u)}finally{n.f()}}else if(e.constructor==Object)for(var a=0,s=Object.entries(e);a<s.length;a++){var o=(0,O.Z)(s[a],2);o[0];U(o[1],t)}else if(ArrayBuffer.isView(e)){if(!(e.buffer instanceof ArrayBuffer))throw"only ArrayBuffers should be in the message payload";t.push(e.buffer)}}var j=r(8308),R=r(1414);function C(e,t){if(!(t in e.children))return null;if("DataSet"!==e.children[t])return null;var r=e.open(t);return"String"!==r.type?null:r.load()}function F(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"\t",n=t.name.split(".").pop();"gz"==n&&(e=j.ec(e));var a=new TextDecoder,s=a.decode(e),o=R.Z(r),u=o.parseRows(s);return u}function z(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return e+String(Number(new Date))+t}function P(e,t){var r={format:"10X",files:[]};if(1!=e.file.length)throw new Error("expected exactly one 'h5' file");var n=e.file[0];return r.files.push({type:"h5",name:n.name,buffer:t(n)}),r}function I(e){var t=null;if(!("matrix"in e.children)||"Group"!=e.children.matrix)throw new Error("expected a 'matrix' group at the top level of the file");var r=e.open("matrix");if("features"in r.children&&"Group"==r.children.features){var n=r.open("features"),a=C(n,"id");if(null!==a){t={id:a};var s=C(n,"name");null!==s&&(t.name=s)}}return t}function B(e){var t={},r=z("10x_",".h5");k.NC(r,new Uint8Array(e.files[0].buffer));try{var n=new k.pT(r);t.genes=I(n),t.annotations=null}finally{k.Yd(r)}return t}function q(e){var t={},r=z("10x_",".h5");k.NC(r,new Uint8Array(e.files[0].buffer));try{t.matrix=k.EF(r,"matrix");var n=new k.pT(r);t.genes=I(n),t.annotations=null}catch(a){throw A(t.matrix),a}finally{k.Yd(r)}return t}function K(e,t){var r={format:"H5AD",files:[]};if(1!=e.file.length)throw new Error("expected exactly one 'h5' file");var n=e.file[0];return r.files.push({type:"h5",name:n.name,buffer:t(n)}),r}function L(e){var t=null;if("var"in e.children&&"Group"==e.children.var){var r=e.open("var"),n=C(r,"_index");if(null!==n){t={_index:n};for(var a=0,s=Object.entries(r.children);a<s.length;a++){var o=(0,O.Z)(s[a],2),u=o[0];if("DataSet"===o[1]&&(u.match(/name/i)||u.match(/symb/i))){var i=r.open(u);"String"==i.type&&(t[u]=i.load())}}}}return t}function W(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t.namesOnly,n=void 0!==r&&r,a=null;if("obs"in e.children&&"Group"==e.children.obs){var s=e.open("obs");a={};var o=C(s,"_index");null!==o&&(a._index=o);for(var u=0,i=Object.entries(s.children);u<i.length;u++){var c=(0,O.Z)(i[u],2),l=c[0],f=c[1];if("DataSet"==f){var p=s.open(l);"Other"!=p.type&&(a[l]=n?null:p.load())}}if(!n&&"__categories"in s.children&&"Group"==s.children.__categories)for(var m=s.open("__categories"),d=0,h=Object.entries(m.children);d<h.length;d++){var v=(0,O.Z)(h[d],2),y=v[0],g=v[1];if(y in a){var b=C(m,y);null!==b.type&&(a[y]={type:"factor",index:g,factor:b})}}}return n&&null!==a?Object.keys(a):a}function Y(e){var t={},r=z("h5ad_",".h5");k.NC(r,new Uint8Array(e.files[0].buffer));try{var n=new k.pT(r);t.genes=L(n);var a=W(n,{load:!1});t.annotations=Object.keys(a)}finally{k.Yd(r)}return t}function J(e){var t={},r=z("h5ad_",".h5");k.NC(r,new Uint8Array(e.files[0].buffer));try{t.matrix=k.EF(r,"X");var n=new k.pT(r);t.genes=L(n),t.annotations=W(n)}finally{k.Yd(r)}return t}function H(e,t){var r={format:"MatrixMarket",files:[]};if(1!=e.mtx.length)throw new Error("expected exactly one 'mtx' file");var n=e.mtx[0];if(r.files.push({type:"mtx",name:n.name,buffer:t(n)}),"gene"in e){if(1!==e.gene.length)throw"expected no more than one gene file";var a=e.gene[0];r.files.push({type:"genes",name:a.name,buffer:t(a)})}if("barcode"in e){if(1!==e.barcode.length)throw"expected no more than one cell annotation file";var s=e.barcode[0];r.files.push({type:"annotations",name:s.name,buffer:t(s)})}return r}function V(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t.numberOfRows,n=void 0===r?null:r,a=null,s=e.filter((function(e){return"genes"==e.type}));if(1==s.length){var o=s[0],u=new Uint8Array(o.buffer),i=F(u,o);if(null!==n&&i.length!==n)throw new Error("number of matrix rows is not equal to the number of genes in '"+o.name+"'");var c=[],l=[];i.forEach((function(e){c.push(e[0]),l.push(e[1])})),a={id:c,symbol:l}}return a}function X(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t.numberOfColumns,n=void 0===r?null:r,a=t.namesOnly,s=void 0!==a&&a,o=null,u=e.filter((function(e){return"annotations"==e.type}));if(1==u.length){var i,c=u[0],l=new Uint8Array(c.buffer),f=F(l,c),p=!0;if(null!==n){var m=n-f.length;if(0===m)p=!1;else if(-1!==m)throw"number of annotations rows is not equal to the number of cells in '"+c.name+"'"}i=p?f.shift():f[0],s?o=i:(o={},i.forEach((function(e,t){o[e]=f.map((function(e){return e[t]}))})))}return o}function Q(e){return{genes:V(e.files),annotations:X(e.files,{namesOnly:!0})}}function $(e){var t=e.files.filter((function(e){return"mtx"==e.type}))[0],r=new Uint8Array(t.buffer),n="gz"==t.name.split(".").pop(),a={};try{a.matrix=k.DK(r,{compressed:n}),a.genes=V(e.files,{numberOfRows:a.matrix.numberOfRows()}),a.annotations=X(e.files,{numberOfColumns:a.matrix.numberOfColumns()})}catch(s){throw A(a.matrix),s}return a}function ee(e){var t={},r={};for(var n in e.genes){var a=k.gn(e.genes[n]);(!t["".concat(a.type,"-").concat(a.species)]||a.confidence>t["".concat(a.type,"-").concat(a.species)])&&(t["".concat(a.type,"-").concat(a.species)]=a.confidence,r["".concat(a.type,"-").concat(a.species)]=n)}return{scores:t,fields:r}}function te(e){for(var t=0,r=Object.keys(e),n={"symbol-mouse":[],"symbol-human":[],"ensembl-mouse":[],"ensembl-human":[]},a=JSON.parse(JSON.stringify(n)),s=0;s<r.length;s++){var o=ee(e[r[s]]);for(var u in o.fields)a[u].push(o.fields[u]);for(var i in o.scores)n[i].push(o.scores[i])}var c,l,f=-1e3;for(var p in n)if(n[p].length==r.length){var m=n[p].reduce((function(e,t){return e*t}));m>f&&(f=m,c=p)}if(c){l=e[r[0]].genes[a[c][0]];for(var d=function(){var t=new Set(e[r[h]].genes[a[c][h]]);l=l.filter((function(e){return t.has(e)}))},h=1;h<Object.keys(e).length;h++)d();t=l.length}return{num_common_genes:t,intersection:l,best_fields:c?a[c]:null}}function re(e){var t;switch(e){case"mtx":case"MatrixMarket":t=s;break;case"tenx":case"hdf5":case"10X":t=n;break;case"h5ad":case"H5AD":t=a;break;default:throw"unknown matrix file extension: '"+e+"'"}return t}var ne={},ae={},se={},oe=!1;function ue(e){for(var t=[],r=0;r<e;r++)t.push("Gene ".concat(r+1));return{id:t}}function ie(e,t){var r=function(e,t){var r={};try{for(var n=0,a=Object.entries(e);n<a.length;n++){var s=(0,O.Z)(a[n],2),o=s[0],u=s[1],i=re(u.format).loadData(u);"genes"in i||(i.genes=ue(i.matrix.numberOfRows())),i.matrix.isPermuted()&&k.dc(i.matrix,i.genes),r[o]=i}}catch(N){for(var c=0,l=Object.entries(r);c<l.length;c++){var f=(0,O.Z)(l[c],2);f[0],A(f[1].matrix)}throw N}var p=Object.keys(r);if(p.sort(),1==p.length){var m=r[p[0]],d=null,h=null;if(t&&null!==t)try{var v=m.annotations[t],y=m.matrix.numberOfColumns();if(v.length!=y)throw new Error("length of sample factor '"+t+"' should be equal to the number of cells");d=k.Wf(y),h=[];var g=d.array(),b={};v.forEach((function(e,t){e in b||(b[e]=h.length,h.push(e)),g[t]=b[e]}))}catch(N){throw A(d),A(m.matrix),N}return m.block_ids=d,m.block_levels=h,m}var _,w={};try{var S;!function(){var e=te(r).best_fields,t=[],n=[],a=0;for(S=0;S<p.length;S++){var s=r[p[S]];t.push(s.genes[e[S]]),n.push(s.matrix),a+=s.matrix.numberOfColumns()}var o=(_=k.Wf(a)).array(),u=new Array(a),i=0;for(S=0;S<p.length;S++){var c=i;i+=r[p[S]].matrix.numberOfColumns(),o.fill(S,c,i),u.fill(p[S],c,i)}w.block_ids=_,w.block_levels=p;var l=k.KV(n,t);w.matrix=l.matrix;var f=n[0].permutation({restore:!1});w.indices=l.indices.map((function(e){return f[e]}));var m=new Set(l.indices);w.genes={};for(var d=r[p[0]].genes,h=0,v=Object.entries(d);h<v.length;h++){var y=(0,O.Z)(v[h],2),g=y[0],b=y[1];w.genes[g]=b.filter((function(e,t){return m.has(t)}))}var x,E=new Set,N=(0,D.Z)(p);try{for(N.s();!(x=N.n()).done;){var M=x.value,T=r[M];if(null!==T.annotations)for(var A=0,Z=Object.keys(T.annotations);A<Z.length;A++){var U=Z[A];E.add(U)}}}catch(W){N.e(W)}finally{N.f()}var j,R=(0,G.Z)(E),C={},F=(0,D.Z)(R);try{for(F.s();!(j=F.n()).done;){var z,P=j.value,I=[],B=(0,D.Z)(p);try{for(B.s();!(z=B.n()).done;){var q=z.value,K=r[q],L=void 0;K.annotations&&K.annotations[P]?(L=K.annotations[P])instanceof Array||(L=Array.from(L)):L=new Array(K.matrix.numberOfColumns()),I=I.concat(L)}}catch(W){B.e(W)}finally{B.f()}C[P]=I}}catch(W){F.e(W)}finally{F.f()}w.annotations=C,w.annotations.__batch__=u}()}catch(N){throw A(_),N}finally{for(var x=0,E=Object.values(r);x<E.length;x++)A(E[x].matrix)}return w}(e,t);ne.matrix=r.matrix,ne.genes=r.genes,ne.annotations=r.annotations,ne.block_ids=r.block_ids,ne.block_levels=r.block_levels,ne.indices=r.indices}function ce(e,t){var r=Object.entries(e);if(1==r.length){var n=r[0][1].format;if("kana"==n||"kanadb"==n)return}oe=!0;for(var a={},s=0,o=r;s<o.length;s++){var u=(0,O.Z)(o[s],2),i=u[0],c=u[1],l=re(c.format);a[i]=l.formatFiles(c,(function(e){return e.size}))}if(f=a,p=se,JSON.stringify(f)!=JSON.stringify(p)||ae.sample_factor!==t){for(var f,p,m={},d=0,h=Object.entries(e);d<h.length;d++){var v=(0,O.Z)(h[d],2),y=v[0],g=v[1],b=re(g.format);m[y]=b.formatFiles(g,(function(e){return(new FileReaderSync).readAsArrayBuffer(e)}))}A(ne.matrix),A(ne.block_ids),ie(m,t),se=a,ae.files=m,ae.sample_factor=t}else oe=!1}function le(){var e={dimensions:{num_genes:ne.matrix.numberOfRows(),num_cells:ne.matrix.numberOfColumns()},genes:(0,x.Z)({},ne.genes)};return ne.annotations&&(e.annotations=Object.keys(ne.annotations)),e}function fe(e,t,r){return pe.apply(this,arguments)}function pe(){return(pe=(0,_.Z)(S().mark((function e(t,r,n){var a,s,o,u,i,c,l,f,p,m,d,h,v,y,g,b,_,w,k,x,G,E,N,M;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(a=t.createGroup("inputs"),s=!1,o=a.createGroup("parameters"),u=[],i=[],c=[],l=[],f=0,p=Object.entries(ae.files);f<p.length;f++){m=(0,O.Z)(p[f],2),d=m[0],h=m[1],u.push(h.format),v=(0,D.Z)(h.files);try{for(v.s();!(y=v.n()).done;)g=y.value,i.push(g)}catch(S){v.e(S)}finally{v.f()}c.push(d),l.push(h.files.length)}u.length>1?(s=!0,o.writeDataSet("format","String",null,u),o.writeDataSet("sample_groups","Int32",null,l),o.writeDataSet("sample_names","String",null,c)):o.writeDataSet("format","String",[],u[0]),b=o.createGroup("files"),_=(0,D.Z)(i.entries()),e.prev=11,_.s();case 13:if((w=_.n()).done){e.next=24;break}return k=(0,O.Z)(w.value,2),x=k[0],G=k[1],(E=b.createGroup(String(x))).writeDataSet("type","String",[],G.type),E.writeDataSet("name","String",[],G.name),e.next=20,r(G);case 20:N=e.sent,n?(E.writeDataSet("offset","Uint32",[],N.offset),E.writeDataSet("size","Uint32",[],N.size)):E.writeDataSet("id","String",[],N);case 22:e.next=13;break;case 24:e.next=29;break;case 26:e.prev=26,e.t0=e.catch(11),_.e(e.t0);case 29:return e.prev=29,_.f(),e.finish(29);case 32:return(M=a.createGroup("results")).writeDataSet("dimensions","Int32",null,[ne.matrix.numberOfRows(),ne.matrix.numberOfColumns()]),null!==ne.block_levels&&M.writeDataSet("num_samples","Int32",[],ne.block_levels.length),s?M.writeDataSet("indices","Int32",null,ne.indices):M.writeDataSet("permutation","Int32",null,ne.matrix.permutation({copy:"view"})),e.abrupt("return");case 37:case"end":return e.stop()}}),e,null,[[11,26,29,32]])})))).apply(this,arguments)}function me(e,t,r){return de.apply(this,arguments)}function de(){return(de=(0,_.Z)(S().mark((function e(t,r,n){var a,s,o,u,i,c,l,f,p,m,d,h,v,y,g,b,_,w,x,G,D,O,E,N,M,T,A,Z,U,j,R,C,F,z,P,I,B,q,K,L;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=t.open("inputs"),s=a.open("parameters"),o=s.open("files"),u=o.children,i=new Array(u.length),c=0,l=Object.keys(u);case 6:if(!(c<l.length)){e.next=28;break}for(f=l[c],p=o.open(f),m={},d=0,h=["type","name"];d<h.length;d++)v=h[d],y=p.open(v,{load:!0}),m[v]=y.values[0];if(n){e.next=18;break}return g=p.open("id",{load:!0}),e.next=15,r(g.values[0]);case 15:m.buffer=e.sent,e.next=23;break;case 18:for(b={},_=0,w=["offset","size"];_<w.length;_++)x=w[_],G=p.open(x,{load:!0}),b[x]=G.values[0];return e.next=22,r(b.offset,b.size);case 22:m.buffer=e.sent;case 23:D=Number(f),i[D]=m;case 25:c++,e.next=6;break;case 28:if(ae={files:{},sample_factor:null},O=s.open("format",{load:!0}),E=0==O.shape.length)ae.files.default={format:O.values[0],files:i},N=null,"sample_factor"in s.children&&(N=s.open("sample_factor",{load:!0}).values[0]),ae.sample_factor=N;else for(M=O.values,T=s.open("sample_names",{load:!0}).values,A=s.open("sample_groups",{load:!0}).values,Z=0,U=0;U<M.length;U++){for(j=[],R=0;R<A[U];R++)j.push(i[Z]),Z++;ae.files[T[U]]={format:M[U],files:j}}if(ie(ae.files,ae.sample_factor),C=a.open("results"),!E){e.next=40;break}z=null,"permutation"in C.children&&(P=C.open("permutation",{load:!0}),z=k.k_(ne.matrix,P.values)),F=null!==z?function(e){var t=e.slice();e.forEach((function(r,n){t[n]=e[z[n]]})),e.set(t)}:function(e){},e.next=54;break;case 40:if(I=C.open("indices",{load:!0}).values,B=ne.indices,I.length==B.length){e.next=44;break}throw new Error("old and new indices must have the same length for results to be interpretable");case 44:q=!0,U=0;case 46:if(!(U<I.length)){e.next=53;break}if(I[U]==B[U]){e.next=50;break}return q=!1,e.abrupt("break",53);case 50:U++,e.next=46;break;case 53:q?F=function(e){}:(K={},I.forEach((function(e,t){K[e]=t})),L=B.map((function(e){if(!(e in K)||null===K[e])throw new Error("old and new indices should contain the same row identities");var t=K[e];return K[e]=null,t})),F=function(e){return e.map((function(t,r){return e[L[r]]}))});case 54:return e.abrupt("return",F);case 55:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function he(){return ne.matrix}function ve(){return ne.genes}function ye(){if(!("gene_types"in ne)){for(var e={},t=ve(),r=0,n=Object.entries(t);r<n.length;r++){var a=(0,O.Z)(n[r],2),s=a[0],o=a[1];e[s]=k.gn(o)}ne.gene_types=e}return ne.gene_types}function ge(e){var t,r=ne.annotations,n=ne.matrix.numberOfColumns();if(!(e in r))throw"column ".concat(e," does not exist in col.tsv");if("object"===typeof(t=r[e])&&!1===Array.isArray(t)&&"type"in r[e])return r[e];var a={},s=new Uint8Array(n);return r[e].map((function(e,t){e in a||(a[e]=Object.keys(a).length),s[t]=a[e]})),{index:Object.keys(a),factor:s}}function be(){return ne.block_ids}function _e(){return ne.block_levels}function we(e){for(var t={},r=0,n=Object.entries(e);r<n.length;r++){var a=(0,O.Z)(n[r],2),s=a[0],o=a[1],u=re(o.format),i=u.formatFiles(o,(function(e){return(new FileReaderSync).readAsArrayBuffer(e)}));t[s]=u.loadPreflight(i)}return function(e){for(var t,r,n,a=!0,s=0,o=Object.keys(e),u=[],i=[],c=0,l=Object.entries(e);c<l.length;c++){var f=(0,O.Z)(l[c],2),p=(f[0],f[1]);if(!("genes"in p)&&(a=!1,o.length>1)){i.push("all imported datasets must contain genes for integration/batch correction");break}u.push(p.annotations)}return a&&(0==(s=null===(r=t=te(e))||void 0===r?void 0:r.num_common_genes)&&(a=!1,i.push("no common genes across datasets")),1!==o.length&&(null!==(n=t)&&void 0!==n&&n.best_fields||(a=!1,i.push("we cannot guess the best set of feature columns to use for integrating datasets")))),1==o.length&&(a=!0),{valid:a,common_genes:s,annotations:u,errors:i,best_genes:t.best_fields}}(t)}var Se=r(5671),ke=r(3144),xe={};xe.ensembl=new Set(["ENSMUSG00000064336","ENSMUSG00000064337","ENSMUSG00000064338","ENSMUSG00000064339","ENSMUSG00000064340","ENSMUSG00000064341","ENSMUSG00000064342","ENSMUSG00000064343","ENSMUSG00000064344","ENSMUSG00000064345","ENSMUSG00000064346","ENSMUSG00000064347","ENSMUSG00000064348","ENSMUSG00000064349","ENSMUSG00000064350","ENSMUSG00000064351","ENSMUSG00000064352","ENSMUSG00000064353","ENSMUSG00000064354","ENSMUSG00000064355","ENSMUSG00000064356","ENSMUSG00000064357","ENSMUSG00000064358","ENSMUSG00000064359","ENSMUSG00000064360","ENSMUSG00000064361","ENSMUSG00000064363","ENSMUSG00000064364","ENSMUSG00000064365","ENSMUSG00000064366","ENSMUSG00000064367","ENSMUSG00000064368","ENSMUSG00000064369","ENSMUSG00000064370","ENSMUSG00000064371","ENSMUSG00000064372","ENSMUSG00000065947","ENSG00000198695","ENSG00000198712","ENSG00000198727","ENSG00000198763","ENSG00000198786","ENSG00000198804","ENSG00000198840","ENSG00000198886","ENSG00000198888","ENSG00000198899","ENSG00000198938","ENSG00000209082","ENSG00000210049","ENSG00000210077","ENSG00000210082","ENSG00000210100","ENSG00000210107","ENSG00000210112","ENSG00000210117","ENSG00000210127","ENSG00000210135","ENSG00000210140","ENSG00000210144","ENSG00000210151","ENSG00000210154","ENSG00000210156","ENSG00000210164","ENSG00000210174","ENSG00000210176","ENSG00000210184","ENSG00000210191","ENSG00000210194","ENSG00000210195","ENSG00000210196","ENSG00000211459","ENSG00000212907","ENSG00000228253"]),xe.symbol=new Set(["mt-Tf","mt-Rnr1","mt-Tv","mt-Rnr2","mt-Tl1","mt-Nd1","mt-Ti","mt-Tq","mt-Tm","mt-Nd2","mt-Tw","mt-Ta","mt-Tn","mt-Tc","mt-Ty","mt-Co1","mt-Ts1","mt-Td","mt-Co2","mt-Tk","mt-Atp8","mt-Atp6","mt-Co3","mt-Tg","mt-Nd3","mt-Tr","mt-Nd4","mt-Th","mt-Ts2","mt-Tl2","mt-Nd5","mt-Nd6","mt-Te","mt-Cytb","mt-Tt","mt-Tp","mt-Nd4l","MT-ND6","MT-CO2","MT-CYB","MT-ND2","MT-ND5","MT-CO1","MT-ND3","MT-ND4","MT-ND1","MT-ATP6","MT-CO3","MT-TL1","MT-TF","MT-TV","MT-RNR2","MT-TI","MT-TQ","MT-TM","MT-TW","MT-TA","MT-TN","MT-TC","MT-TY","MT-TS1","MT-TD","MT-TK","MT-TG","MT-TR","MT-TH","MT-TS2","MT-TL2","MT-TE","MT-TT","MT-TP","MT-RNR1","MT-ND4L","MT-ATP8"]);var Ge={},De={},Oe=!1;function Ee(){var e=he(),t=Fe();A(Ge.matrix),Ge.matrix=k.b_(e,t);var r=be();if(Ge.blocked=null!==r,Ge.blocked)for(var n=Z(Ge.matrix.numberOfColumns(),"Int32Array",Ge,"block_buffer").array(),a=r.array(),s=t.array(),o=0,u=0;u<a.length;u++)0==s[u]&&(n[o]=a[u],o++)}function Ne(e,t,r){var n=oe||e!==De.use_mito_default||t!==De.mito_prefix,a=n||r!==De.nmads,s=a;Ge.filters instanceof je&&s&&(a=!0),Ge.metrics instanceof Ue&&(s||a)&&(n=!0),n&&(!function(e,t){var r=he(),n=Z(1*r.numberOfRows(),"Uint8Array",Ge,"metrics_buffer");n.fill(0);for(var a=ve(),s=n.array(),o=0,u=Object.entries(a);o<u.length;o++){var i=(0,O.Z)(u[o],2),c=(i[0],i[1]);if(e)c.forEach((function(e,t){(xe.symbol.has(e)||xe.ensembl.has(e))&&(s[t]=1)}));else{var l=t.toLowerCase();c.forEach((function(e,t){e.toLowerCase().startsWith(l)&&(s[t]=1)}))}}A(Ge.metrics),Ge.metrics=k.i4(r,n)}(e,t),De.use_mito_default=e,De.mito_prefix=t),a&&(!function(e){var t=be();A(Ge.filters),Ge.filters=k.rU(Ge.metrics,{numberOfMADs:e,block:t})}(r),De.nmads=r),s&&(Ee(),Oe=!0)}function Me(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return e=M(e),{sums:Ge.metrics.sums({copy:e}),detected:Ge.metrics.detected({copy:e}),proportion:Ge.metrics.subsetProportions(0,{copy:e})}}function Te(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return e=M(e),{sums:Ge.filters.thresholdsSums({copy:e}),detected:Ge.filters.thresholdsDetected({copy:e}),proportion:Ge.filters.thresholdsSubsetProportions(0,{copy:e})}}function Ae(){var e={},t=_e();null===t?(t=["default"],e.default=Me()):function(){var r=Me(),n=be().array();for(a=0;a<t.length;a++){for(var s={},o=0,u=Object.entries(r);o<u.length;o++){var i=(0,O.Z)(u[o],2),c=i[0],l=i[1];s[c]=l.filter((function(e,t){return n[t]==a}))}e[t[a]]=s}}();for(var r={},n=Te(),a=0;a<t.length;a++){for(var s={},o=0,u=Object.entries(n);o<u.length;o++){var i=(0,O.Z)(u[o],2),c=i[0],l=i[1];s[c]=l[a]}r[t[a]]=s}var f={};for(a=0;a<t.length;a++){for(var p={},m=e[t[a]],d=0,h=Object.entries(m);d<h.length;d++){var v=(0,O.Z)(h[d],2),y=v[0],g=v[1],b=-1/0,_=1/0;g.forEach((function(e){b<e&&(b=e),_>e&&(_=e)})),p[y]=[_,b]}f[t[a]]=p}var w=0;return"matrix"in Ge?w=Ge.matrix.numberOfColumns():Fe().array().forEach((function(e){0==e&&w++})),{data:e,ranges:f,thresholds:r,retained:w}}function Ze(e){var t=e.createGroup("quality_control"),r=t.createGroup("parameters");r.writeDataSet("use_mito_default","Uint8",[],Number(De.use_mito_default)),r.writeDataSet("mito_prefix","String",[],De.mito_prefix),r.writeDataSet("nmads","Float64",[],De.nmads);var n=t.createGroup("results"),a=n.createGroup("metrics"),s=Me(!1);a.writeDataSet("sums","Float64",null,s.sums),a.writeDataSet("detected","Int32",null,s.detected),a.writeDataSet("proportion","Float64",null,s.proportion);for(var o=n.createGroup("thresholds"),u=Te(!1),i=0,c=["sums","detected","proportion"];i<c.length;i++){var l=c[i],f=u[l];o.writeDataSet(l,"Float64",null,f)}var p=Fe();n.writeDataSet("discards","Uint8",null,p)}var Ue=function(){function e(t,r,n){(0,Se.Z)(this,e),this.sums_=t,this.detected_=r,this.proportion_=n}return(0,ke.Z)(e,[{key:"sums",value:function(e){var t=e.copy;return T(this.sums_,t)}},{key:"detected",value:function(e){var t=e.copy;return T(this.detected_,t)}},{key:"subsetProportions",value:function(e,t){var r=t.copy;if(0!=e)throw"only 'index = 0' is supported for mimics";return T(this.proportion_,r)}},{key:"free",value:function(){}}]),e}(),je=function(){function e(t,r,n,a){(0,Se.Z)(this,e),this.sums_=t,this.detected_=r,this.proportion_=n,this.discards=k.TS(a.length),this.discards.set(a)}return(0,ke.Z)(e,[{key:"thresholdsSums",value:function(e){var t=e.copy;return T(this.sums_,t)}},{key:"thresholdsDetected",value:function(e){var t=e.copy;return T(this.detected_,t)}},{key:"thresholdsSubsetProportions",value:function(e,t){var r=t.copy;if(0!=e)throw"only 'index = 0' is supported for mimics";return T(this.proportion_,r)}},{key:"discardOverall",value:function(e){var t=e.copy;return T(this.discards,t)}},{key:"free",value:function(){this.discards.free()}}]),e}();function Re(e){var t=e.open("quality_control"),r=t.open("parameters");De={use_mito_default:r.open("use_mito_default",{load:!0}).values[0]>0,mito_prefix:r.open("mito_prefix",{load:!0}).values[0],nmads:r.open("nmads",{load:!0}).values[0]};var n=t.open("results"),a=n.open("metrics");Ge.metrics=new Ue(a.open("sums",{load:!0}).values,a.open("detected",{load:!0}).values,a.open("proportion",{load:!0}).values);var s=n.open("thresholds"),o=s.open("sums",{load:!0}).values,u=s.open("detected",{load:!0}).values,i=s.open("proportion",{load:!0}).values,c=n.open("discards",{load:!0}).values;return Ge.filters=new je(o,u,i,c),(0,x.Z)({},De)}function Ce(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.unsafe,r=void 0!==t&&t;return Ge.metrics.sums({copy:!r})}function Fe(){return Ge.filters.discardOverall({copy:"view"})}function ze(){return"matrix"in Ge||Ee(),Ge.matrix}function Pe(){return"blocked"in Ge||Ee(),Ge.blocked?Ge.block_buffer:null}var Ie={},Be=!1;function qe(){var e=ze(),t=Z(e.numberOfColumns(),"Float64Array",Ie),r=Fe(),n=Ce({unsafe:!0}),a=t.array(),s=0;if(r.array().forEach((function(e,t){e||(a[s]=n[t],s++)})),s!=e.numberOfColumns())throw"normalization and filtering are not in sync";var o=Pe();A(Ie.matrix),Ie.matrix=k.gk(e,{sizeFactors:t,block:o})}function Ke(){Be=!1,Oe&&(Be=!0),Be&&qe()}function Le(){return{}}function We(e){var t=e.createGroup("normalization");t.createGroup("parameters"),t.createGroup("results")}function Ye(e){}function Je(){return"matrix"in Ie||qe(),Ie.matrix}function He(e){var t=Je(),r=Z(t.numberOfColumns(),"Float64Array",Ie);return t.row(e,{buffer:r}),r.slice()}var Ve={},Xe={},Qe=!1;function $e(e){if(Qe=!1,Be||e!=Xe.span){A(Ve.results);var t=Je(),r=Pe();Ve.results=k.rY(t,{span:e,block:r}),Ve.sorted_residuals=Ve.results.residuals().slice(),Ve.sorted_residuals.sort(),Xe.span=e,Qe=!0}}function et(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return e=M(e),{means:Ve.results.means({copy:e}),vars:Ve.results.variances({copy:e}),fitted:Ve.results.fitted({copy:e}),resids:Ve.results.residuals({copy:e})}}function tt(){return et()}function rt(e){var t=e.createGroup("feature_selection");t.createGroup("parameters").writeDataSet("span","Float64",[],Xe.span);for(var r=et(!1),n=t.createGroup("results"),a=0,s=["means","vars","fitted","resids"];a<s.length;a++){var o=s[a];n.writeDataSet(o,"Float64",null,r[o])}}var nt=function(){function e(t,r,n,a){(0,Se.Z)(this,e),this.means_=t,this.vars_=r,this.fitted_=n,this.resids_=a}return(0,ke.Z)(e,[{key:"means",value:function(e){var t=e.copy;return T(this.means_,t)}},{key:"variances",value:function(e){var t=e.copy;return T(this.vars_,t)}},{key:"fitted",value:function(e){var t=e.copy;return T(this.fitted_,t)}},{key:"residuals",value:function(e){var t=e.copy;return T(this.resids_,t)}},{key:"free",value:function(){}}]),e}();function at(e,t){var r=e.open("feature_selection"),n=r.open("parameters");Xe={span:n.open("span",{load:!0}).values[0]};for(var a=r.open("results"),s={},o=0,u=["means","vars","fitted","resids"];o<u.length;o++){var i=u[o],c=a.open(i,{load:!0}).values;t(c),s[i]=c}return Ve.results=new nt(s.means,s.vars,s.fitted,s.resids),Ve.sorted_residuals=Ve.results.residuals({copy:!0}),Ve.sorted_residuals.sort(),(0,x.Z)({},Xe)}function st(){return Ve.sorted_residuals}function ot(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.unsafe,r=void 0!==t&&t;return Ve.results.residuals({copy:!r})}var ut={},it={},ct=!1;function lt(e){var t=st(),r=t[t.length-e],n=Z(t.length,"Uint8Array",ut,"hvg_buffer"),a=ot({unsafe:!0});n.array().forEach((function(e,t,n){n[t]=a[t]>=r}))}function ft(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"none";if(ct=!1,(Qe||e!==it.num_hvgs)&&(lt(e),it.num_hvgs=e,ct=!0),ct||Be||t!==it.num_pcs){"hvg_buffer"in ut||lt(it.num_hvgs);var n=ut.hvg_buffer,a=Pe(),s="block";"none"==r?a=null:"mnn"==r&&(s="weight");var o=Je();if(A(ut.pcs),ut.pcs=k.a9(o,{features:n,numberOfPCs:t,block:a,blockMethod:s}),"mnn"==r){var u=ut.pcs.principalComponents({copy:"view"}),i=Z(u.length,"Float64Array",ut,"corrected");k.F5(ut.pcs,a,{buffer:i})}it.num_pcs=t,it.block_method=r,ct=!0}}function pt(){var e=ut.pcs,t=e.varianceExplained(),r=e.totalVariance();return t.forEach((function(e,n){t[n]=e/r})),{var_exp:t}}function mt(e){var t=e.createGroup("pca"),r=t.createGroup("parameters");r.writeDataSet("num_hvgs","Int32",[],it.num_hvgs),r.writeDataSet("num_pcs","Int32",[],it.num_pcs),r.writeDataSet("block_method","String",[],it.block_method);var n=t.createGroup("results"),a=pt().var_exp;n.writeDataSet("var_exp","Float64",null,a);var s=vt(!0);if(n.writeDataSet("pcs","Float64",[s.num_obs,s.num_pcs],s.pcs),"mnn"==it.block_method){var o=ut.corrected;n.writeDataSet("corrected","Float64",[s.num_obs,s.num_pcs],o)}}var dt=function(){function e(t,r){(0,Se.Z)(this,e),this.var_exp=r,this.pcs=k.RJ(t.length),this.pcs.set(t)}return(0,ke.Z)(e,[{key:"principalComponents",value:function(e){var t=e.copy;return T(this.pcs,t)}},{key:"varianceExplained",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.copy,r=void 0===t||t;return T(this.var_exp,r)}},{key:"totalVariance",value:function(){return 1}},{key:"free",value:function(){this.pcs.free()}}]),e}();function ht(e){var t=e.open("pca"),r=t.open("parameters");it={num_hvgs:r.open("num_hvgs",{load:!0}).values[0],num_pcs:r.open("num_pcs",{load:!0}).values[0]},"block_method"in r.children?it.block_method=r.open("block_method",{load:!0}).values[0]:it.block_method="none";var n=t.open("results"),a=n.open("var_exp",{load:!0}).values,s=n.open("pcs",{load:!0}).values;if(ut.pcs=new dt(s,a),"mnn"==it.block_method){var o=n.open("corrected",{load:!0}).values;Z(o.length,"Float64Array",ut,"corrected").set(o)}return(0,x.Z)({},it)}function vt(){var e,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return{pcs:e=t||"mnn"!=it.block_method?ut.pcs.principalComponents({copy:"view"}):ut.corrected,num_pcs:it.num_pcs,num_obs:e.length/it.num_pcs}}var yt={},gt={},bt=!1;function _t(e){var t=vt();yt.raw=k.Fu(t.pcs,{approximate:e,numberOfDims:t.num_pcs,numberOfCells:t.num_obs})}function wt(e){bt=!1,(ct||e!=gt.approximate)&&(_t(e),gt.approximate=e,bt=!0)}function St(){return{}}function kt(e){var t=e.createGroup("neighbor_index");t.createGroup("parameters").writeDataSet("approximate","Uint8",[],Number(gt.approximate)),t.createGroup("results")}function xt(e){var t=e.open("neighbor_index").open("parameters");return gt={approximate:t.open("approximate",{load:!0}).value>0},(0,x.Z)({},gt)}function Gt(){return"raw"in yt||_t(gt.approximate),yt.raw}var Dt={},Ot={},Et=!1;function Nt(){return"clusters"in Dt}function Mt(){if(Nt())return Dt.clusters.membership({copy:"view"});throw"cannot fetch SNN clusters from an invalid state"}function Tt(e,t,r,n){Et=!1;var a=bt||t!==Ot.k,s=a||r!==Ot.scheme,o=s||n!==Ot.resolution;e&&!Nt()&&(o=!0),"graph"in Dt||o&&(s=!0),"neighbors"in Dt||(s||o)&&(a=!0),a&&(A(Dt.neighbors),e?Dt.neighbors=k.wf(Gt(),t):delete Dt.neighbors,Ot.k=t),s&&(A(Dt.graph),e?Dt.graph=k.bD(Dt.neighbors,{scheme:r}):delete Dt.graph,Ot.scheme=r),o&&(A(Dt.clusters),e?Dt.clusters=k.ZI(Dt.graph,{resolution:n}):delete Dt.clusters,Ot.resolution=n,Et=!0)}function At(){return{}}function Zt(e){var t=e.createGroup("snn_graph_cluster"),r=t.createGroup("parameters");r.writeDataSet("k","Int32",[],Ot.k),r.writeDataSet("scheme","String",[],["rank","number","jaccard"][Ot.scheme]),r.writeDataSet("resolution","Float64",[],Ot.resolution);var n=t.createGroup("results");if(Nt()){var a=Mt();n.writeDataSet("clusters","Int32",null,a)}}var Ut=function(){function e(t){(0,Se.Z)(this,e),this.buffer=k.Wf(t.length),this.buffer.set(t)}return(0,ke.Z)(e,[{key:"membership",value:function(e){var t=e.copy;return T(this.buffer,t)}},{key:"free",value:function(){this.buffer.free()}}]),e}();function jt(e){var t=e.open("snn_graph_cluster"),r=t.open("parameters");(Ot={k:r.open("k",{load:!0}).values[0],scheme:r.open("scheme",{load:!0}).values[0],resolution:r.open("resolution",{load:!0}).values[0]}).scheme={rank:0,number:1,jaccard:2}[Ot.scheme];var n=t.open("results");if("clusters"in n.children){var a=n.open("clusters",{load:!0}).values;Dt.clusters=new Ut(a)}return(0,x.Z)({},Ot)}var Rt={},Ct={},Ft=!1;function zt(){return"raw"in Rt}function Pt(){if(zt())return Rt.raw.clusters({copy:"view"});throw"cannot fetch k-means clusters from an invalid state"}function It(e,t){Ft=!1;var r=ct||t!=Ct.k;if(e&&!zt()&&(r=!0),r){if(A(Rt.raw),e){var n=vt();Rt.raw=k.eu(n.pcs,t,{numberOfDims:n.num_pcs,numberOfCells:n.num_obs,initMethod:"pca-part"})}else delete Rt.raw;Ct.k=t,Ft=!0}}function Bt(){return{}}function qt(e){var t=e.createGroup("kmeans_cluster");t.createGroup("parameters").writeDataSet("k","Int32",[],Ct.k);var r=t.createGroup("results");if(zt()){var n=Pt();r.writeDataSet("clusters","Int32",null,n)}}var Kt=function(){function e(t){(0,Se.Z)(this,e),this.buffer=k.Wf(t.length),this.buffer.set(t)}return(0,ke.Z)(e,[{key:"clusters",value:function(e){var t=e.copy;return T(this.buffer,t)}},{key:"free",value:function(){this.buffer.free()}}]),e}();function Lt(e){if(Ct={k:10},"kmeans_cluster"in e.children){var t=e.open("kmeans_cluster"),r=t.open("parameters");Ct.k=r.open("k",{load:!0}).values[0];var n=t.open("results");if("clusters"in n.children){var a=n.open("clusters",{load:!0}).values;Rt.raw=new Kt(a)}}return(0,x.Z)({},Ct)}var Wt={},Yt=!1;function Jt(e){Yt=!0,e==Wt.method&&("snn_graph"==e?Et||(Yt=!1):"kmeans"==e&&(Ft||(Yt=!1))),Wt.method=e}function Ht(){return{clusters:Qt().slice()}}function Vt(e){var t=e.createGroup("choose_clustering");t.createGroup("parameters").writeDataSet("method","String",[],Wt.method),t.createGroup("results")}function Xt(e){var t=e.open("choose_clustering").open("parameters");return Wt={method:t.open("method",{load:!0}).values[0]},(0,x.Z)({},Wt)}function Qt(){return"snn_graph"==Wt.method?Mt():"kmeans"==Wt.method?Pt():void 0}function $t(e){var t=Gt(),r={num_obs:t.numberOfCells()},n=null,a=null,s=null,o=null;try{n=k.wf(t,e),a=k.Wf(n.numberOfCells()),s=k.Wf(n.size()),o=k.RJ(n.size()),n.serialize({runs:a,indices:s,distances:o}),r.size=n.size(),r.runs=a.array().slice(),r.indices=s.array().slice(),r.distances=o.array().slice()}finally{null!==n&&n.free(),null!==a&&a.free(),null!==s&&s.free(),null!==o&&o.free()}return r}function er(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],a=r.counter,s=new Promise((function(e,t){r.promises[a]={resolve:e,reject:t}}));return r.counter++,t.id=a,e.postMessage(t,n),s}function tr(e,t){return e.onmessage=function(e){var r=e.data.type;if(r.endsWith("_iter"))postMessage({type:r,resp:{x:e.data.x,y:e.data.y,iteration:e.data.iteration}},[e.data.x.buffer,e.data.y.buffer]);else{var n=e.data.id,a=t.promises[n];"error"==r?a.reject(e.data.error):a.resolve(e.data.data),delete t.promises[n]}},er(e,{cmd:"INIT"},t)}function rr(e,t,r,n){var a={cmd:"RUN",params:t},s=[];return null!==r&&(a.neighbors=r,U(r,s)),er(e,a,n,s)}var nr={counter:0,promises:{}},ar={},sr=null;function or(){return tr(sr=new Worker(new URL(r.p+r.u(139),r.b),{type:void 0}),nr)}var ur=!1;function ir(e,t,r,n){var a=null;n&&(a=$t(k.Tk(e)));var s={perplexity:e,iterations:t,animate:r};nr.run=rr(sr,s,a,nr)}function cr(e,t,r){var n=bt||e!=ar.perplexity||"reloaded"in nr;(ur=n||t!=ar.iterations)&&(ir(e,t,r,n),ar.perplexity=e,ar.iterations=t,ar.animate=r,delete nr.reloaded)}function lr(e){return fr.apply(this,arguments)}function fr(){return(fr=(0,_.Z)(S().mark((function e(t){var r;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!("reloaded"in nr)){e.next=7;break}return N(r={x:nr.reloaded.x,y:nr.reloaded.y},t),r.iterations=ar.iterations,e.abrupt("return",r);case 7:return e.next=9,nr.run;case 9:return e.abrupt("return",er(sr,{cmd:"FETCH"},nr));case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function pr(){return lr(!0)}function mr(e){return dr.apply(this,arguments)}function dr(){return(dr=(0,_.Z)(S().mark((function e(t){var r,n,a,s;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.createGroup("tsne"),(n=r.createGroup("parameters")).writeDataSet("perplexity","Float64",[],ar.perplexity),n.writeDataSet("iterations","Int32",[],ar.iterations),n.writeDataSet("animate","Uint8",[],Number(ar.animate)),e.next=7,lr(!1);case 7:return a=e.sent,(s=r.createGroup("results")).writeDataSet("x","Float64",null,a.x),s.writeDataSet("y","Float64",null,a.y),e.abrupt("return");case 12:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function hr(e){var t=e.open("tsne"),r=t.open("parameters");ar={perplexity:r.open("perplexity",{load:!0}).values[0],iterations:r.open("iterations",{load:!0}).values[0],animate:r.open("animate",{load:!0}).values[0]>0};var n=t.open("results");return nr.reloaded={x:n.open("x",{load:!0}).values,y:n.open("y",{load:!0}).values},(0,x.Z)({},ar)}function vr(){return"reloaded"in nr?(ir(ar.perplexity,ar.iterations,!0,!0),nr.run.then((function(e){return{type:"tsne_rerun",data:{status:"SUCCESS"}}}))):er(sr,{cmd:"RERUN"},nr)}var yr={counter:0,promises:{}},gr={},br=null;function _r(){br=new Worker(new URL(r.p+r.u(653),r.b),{type:void 0}),yr.initialized=tr(br,yr)}var wr=!1;function Sr(e,t,r,n,a){var s=null;a&&(s=$t(e));var o={num_neighbors:e,num_epochs:t,min_dist:r,animate:n};yr.run=rr(br,o,s,yr)}function kr(e,t,r,n){var a=bt||gr.num_neighbors!=e||"reloaded"in yr;(wr=a||t!=gr.num_epochs||r!=gr.min_dist)&&(Sr(e,t,r,n,a),gr.num_neighbors=e,gr.num_epochs=t,gr.min_dist=r,gr.animate=n,delete yr.reloaded)}function xr(e){return Gr.apply(this,arguments)}function Gr(){return(Gr=(0,_.Z)(S().mark((function e(t){var r;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!("reloaded"in yr)){e.next=7;break}return N(r={x:yr.reloaded.x,y:yr.reloaded.y},t),r.iterations=gr.num_epochs,e.abrupt("return",r);case 7:return e.next=9,yr.run;case 9:return e.abrupt("return",er(br,{cmd:"FETCH"},yr));case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Dr(){return xr(!0)}function Or(e){return Er.apply(this,arguments)}function Er(){return(Er=(0,_.Z)(S().mark((function e(t){var r,n,a,s;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.createGroup("umap"),(n=r.createGroup("parameters")).writeDataSet("num_neighbors","Int32",[],gr.num_neighbors),n.writeDataSet("num_epochs","Int32",[],gr.num_epochs),n.writeDataSet("min_dist","Float64",[],gr.min_dist),n.writeDataSet("animate","Uint8",[],Number(gr.animate)),e.next=8,xr(!1);case 8:return a=e.sent,(s=r.createGroup("results")).writeDataSet("x","Float64",null,a.x),s.writeDataSet("y","Float64",null,a.y),e.abrupt("return");case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Nr(e){var t=e.open("umap"),r=t.open("parameters");gr={num_neighbors:r.open("num_neighbors",{load:!0}).values[0],num_epochs:r.open("num_epochs",{load:!0}).values[0],min_dist:r.open("min_dist",{load:!0}).values[0],animate:r.open("animate",{load:!0}).values[0]>0};var n=t.open("results");return yr.reloaded={x:n.open("x",{load:!0}).values,y:n.open("y",{load:!0}).values},(0,x.Z)({},gr)}function Mr(){return"reloaded"in yr?(Sr(gr.num_neighbors,gr.num_epochs,gr.min_dist,!0,!0),yr.run.then((function(e){return{type:"umap_rerun",data:{status:"SUCCESS"}}}))):er(br,{cmd:"RERUN"},yr)}var Tr={min:0,mean:1,min_rank:4},Ar={0:"min",1:"mean",4:"min_rank"};function Zr(e,t,r){for(var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=n.no_summaries,s=void 0!==a&&a,o=e.createGroup(String(r)),u=0,i=["means","detected"];u<i.length;u++){var c=i[u],l=t[c](r,{copy:"view"});o.writeDataSet(c,"Float64",null,l)}for(var f=function(){var e=m[p],n=e;"delta_detected"==e&&(n="deltaDetected");var a=function(e){return t[n](r,{summary:e,copy:"view"})};if(s){var u=a(Tr.mean);o.writeDataSet(e,"Float64",null,u)}else for(var i=o.createGroup(e),c=0,l=Object.entries(Tr);c<l.length;c++){var f=(0,O.Z)(l[c],2),d=f[0],h=a(f[1]);i.writeDataSet(d,"Float64",null,h)}},p=0,m=["lfc","delta_detected","auc","cohen"];p<m.length;p++)f()}function Ur(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=r.no_summaries,a=void 0!==n&&n,s={},o=0,u=["means","detected"];o<u.length;o++){var i=u[o];s[i]=e.open(i,{load:!0}).values,t(s[i])}for(var c=0,l=["lfc","delta_detected","auc","cohen"];c<l.length;c++){var f=l[c];if(a)s[f]=e.open(f,{load:!0}).values;else{for(var p=e.open(f),m={},d=0,h=Object.keys(Tr);d<h.length;d++){var v=h[d];m[v]=p.open(v,{load:!0}).values,t(m[v])}s[f]=m}}return s}function jr(e,t,r){var n;t&&void 0!==t||(t="cohen-min-rank");var a,s=!1,o=1;if(t.match(/-min$/)?o=0:t.match(/-min-rank$/)&&(s=!0,o=4),t.match(/^cohen-/))a=e.cohen(r,{summary:o,copy:!1});else if(t.match(/^auc-/))a=e.auc(r,{summary:o,copy:!1});else if(t.match(/^lfc-/))a=e.lfc(r,{summary:o,copy:!1});else{if(!t.match(/^delta-d-/))throw"unknown rank type '"+t+"'";a=e.deltaDetected(r,{summary:o,copy:!1})}n=new Int32Array(a.length);for(var u=0;u<n.length;u++)n[u]=u;s?n.sort((function(e,t){return a[e]-a[t]})):n.sort((function(e,t){return a[t]-a[e]}));var i=function(e){for(var t=new Float64Array(e.length),r=0;r<n.length;r++)t[r]=e[n[r]];return t},c=i(e.detected(r,{copy:!1})),l=i(e.means(r,{copy:!1})),f=i(e.lfc(r,{summary:1,copy:!1})),p=i(e.deltaDetected(r,{summary:1,copy:!1}));return{ordering:n,means:l,detected:c,lfc:f,delta_detected:p}}var Rr={},Cr=!1;function Fr(){if(Cr=!1,Be||Yt){var e=Je(),t=Qt(),r=Pe();A(Rr.raw),Rr.raw=k.y5(e,t,{block:r}),Cr=!0}}function zr(){return{}}function Pr(e){var t=e.createGroup("marker_detection");t.createGroup("parameters");for(var r=t.createGroup("results").createGroup("clusters"),n=Rr.raw.numberOfGroups(),a=0;a<n;a++)Zr(r,Rr.raw,a)}var Ir,Br=function(){function e(t){(0,Se.Z)(this,e),this.clusters=t}return(0,ke.Z)(e,[{key:"effect_grabber",value:function(e,t,r,n){var a=Ar[r];return T(this.clusters[t][e][a],n)}},{key:"lfc",value:function(e,t){var r=t.summary,n=t.copy;return this.effect_grabber("lfc",e,r,n)}},{key:"deltaDetected",value:function(e,t){var r=t.summary,n=t.copy;return this.effect_grabber("delta_detected",e,r,n)}},{key:"cohen",value:function(e,t){var r=t.summary,n=t.copy;return this.effect_grabber("cohen",e,r,n)}},{key:"auc",value:function(e,t){var r=t.summary,n=t.copy;return this.effect_grabber("auc",e,r,n)}},{key:"stat_grabber",value:function(e,t,r){return T(this.clusters[t][e],r)}},{key:"means",value:function(e,t){var r=t.copy;return this.stat_grabber("means",e,r)}},{key:"detected",value:function(e,t){var r=t.copy;return this.stat_grabber("detected",e,r)}},{key:"numberOfGroups",value:function(){return Object.keys(this.clusters).length}},{key:"free",value:function(){}}]),e}();function qr(e,t){for(var r=e.open("marker_detection").open("results").open("clusters"),n={},a=0,s=Object.keys(r.children);a<s.length;a++){var o=s[a];n[Number(o)]=Ur(r.open(o),t)}Rr.raw=new Br(n)}function Kr(e,t){return jr(Rr.raw,e,t)}function Lr(){return Rr.raw.numberOfGroups()}function Wr(e,t){var r=t.copy,n=void 0===r||r;return Rr.raw.means(e,{copy:n})}var Yr=null;function Jr(){return null===Yr&&(Yr=new Promise((function(e,t){(Ir=indexedDB.open("DownloadsDB",3)).onupgradeneeded=function(e){var t=e.target.result;try{t.deleteObjectStore("downloads")}catch(e){}t.createObjectStore("downloads",{keyPath:"url"})},Ir.onsuccess=function(){e(null)},Ir.onerror=function(){t("failed to initialize DownloadsDB")}}))),Yr}function Hr(e){return Vr.apply(this,arguments)}function Vr(){return Vr=(0,_.Z)(S().mark((function e(t){var r,n,a,s,o,u,i,c,l,f,p,m,d=arguments;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=d.length>1&&void 0!==d[1]?d[1]:null,n=d.length>2&&void 0!==d[2]&&d[2],e.next=4,Yr;case 4:if(n){e.next=13;break}return a=Ir.result.transaction(["downloads"],"readonly"),s=a.objectStore("downloads"),o=new Promise((function(e){var r=s.get(t);r.onsuccess=function(t){void 0!==r.result?e(r.result.payload):e(null)},r.onerror=function(t){e(null)}})),e.next=10,o;case 10:if(null===(u=e.sent)){e.next=13;break}return e.abrupt("return",u);case 13:return i=null==r?fetch(t):fetch(t,r),e.next=16,i;case 16:if((c=e.sent).ok){e.next=19;break}throw"failed to download '"+t+"' ("+c.status+")";case 19:return e.next=21,c.arrayBuffer();case 21:return l=e.sent,f=Ir.result.transaction(["downloads"],"readwrite"),p=f.objectStore("downloads"),m=new Promise((function(e){var r=p.put({url:t,payload:l});r.onsuccess=function(t){e(!0)},r.onerror=function(t){e(!1)}})),e.next=27,m;case 27:if(e.sent){e.next=30;break}throw"failed to download resources for '"+t+"'";case 30:return e.abrupt("return",l);case 31:case"end":return e.stop()}}),e)}))),Vr.apply(this,arguments)}var Xr={},Qr={},$r=!1,en={},tn={},rn={},nn={},an="https://cors-proxy.aaron-lun.workers.dev",sn="https://github.com/clusterfork/singlepp-references/releases/download/hs-latest",on="https://github.com/clusterfork/singlepp-references/releases/download/mm-latest";function un(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"gz",r=e;"gz"==t&&(r=j.ec(e));var n=new TextDecoder,a=n.decode(r),s=a.split("\n");return s.length>0&&""==s[s.length-1]&&s.pop(),s}function cn(e,t,r){return ln.apply(this,arguments)}function ln(){return ln=(0,_.Z)(S().mark((function e(t,r,n){var a,s,o,u,i,c,l,f,p,m,d,h,v;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("human"==r?(a=sn,o=en,s=rn):(a=on,o=tn,s=nn),Jr(),t in o){e.next=20;break}return e.next=5,Promise.all([Hr(an+"/"+encodeURIComponent(a+"/"+t+"_genes.csv.gz")),Hr(an+"/"+encodeURIComponent(a+"/"+t+"_labels_fine.csv.gz")),Hr(an+"/"+encodeURIComponent(a+"/"+t+"_label_names_fine.csv.gz")),Hr(an+"/"+encodeURIComponent(a+"/"+t+"_markers_fine.gmt.gz")),Hr(an+"/"+encodeURIComponent(a+"/"+t+"_matrix.csv.gz"))]);case 5:u=e.sent,e.prev=6,i=k.tY(new Uint8Array(u[4]),new Uint8Array(u[3]),new Uint8Array(u[1])),c=un(new Uint8Array(u[0])),l=[],f=[],c.forEach((function(e){var t=e.split(",");l.push(t[0]),f.push(t[1])})),p=un(new Uint8Array(u[2])),o[t]={raw:i,genes:{ensembl:l,symbol:f},labels:p},e.next=20;break;case 16:throw e.prev=16,e.t0=e.catch(6),A(i),e.t0;case 20:if(t in s&&!n){e.next=34;break}e.prev=21,t in s&&A(s[t].raw),m=o[t],d=m.raw,h="ensembl"===Xr.feature_details.type?m.genes.ensembl:m.genes.symbol,v=k.St(Xr.features,d,h),s[t]={features:h,raw:v},e.next=34;break;case 30:throw e.prev=30,e.t1=e.catch(21),A(undefined),e.t1;case 34:return e.abrupt("return",{loaded:o[t],built:s[t]});case 35:case"end":return e.stop()}}),e,null,[[6,16],[21,30]])}))),ln.apply(this,arguments)}function fn(e,t){if("undefined"===typeof e||"undefined"===typeof t)return!1;if(e.length!=t.length)return!1;for(var r=0;r<e.length;r++)if(e[r]!=t[r])return!1;return!0}function pn(e,t){$r=!1;var r=!1;!oe&&"feature_space"in Xr||(r=!0,$r=!0,function(){for(var e=ve(),t=ye(),r=null,n=null,a=0,s=Object.entries(t);a<s.length;a++){var o=(0,O.Z)(s[a],2),u=o[0],i=o[1];(null===n||i.confidence>n.confidence)&&(r=u,n=i)}Xr.features=e[r],Xr.feature_details=n}());var n,a=Xr.feature_details.species,s=(Jr(),{});if("human"==a){var o,u=(0,D.Z)(e);try{for(u.s();!(o=u.n()).done;){var i=o.value;s[i]=cn(i,"human",r)}}catch(p){u.e(p)}finally{u.f()}}else if("mouse"==a){var c,l=(0,D.Z)(t);try{for(l.s();!(c=l.n()).done;){var f=c.value;s[f]=cn(f,"mouse",r)}}catch(p){l.e(p)}finally{l.f()}}(fn(e,Qr.human_references)&&fn(t,Qr.mouse_references)||(Qr.human_references=e,Qr.mouse_references=t,$r=!0),$r)&&function(){var e=Xr.features.length,t=Lr(),a=Z(t*e,"Float64Array",Xr);for(n=0;n<t;n++){var o=Wr(n,{copy:!1});a.array().set(o,n*e)}Xr.results={};for(var u=0,i=Object.entries(s);u<i.length;u++){var c=(0,O.Z)(i[u],2),l=c[0],f=c[1];Xr.results[l]=f.then((function(r){var n,s=k.pG(a,r.built.raw,{numberOfFeatures:e,numberOfCells:t}),o=[],u=(0,D.Z)(s);try{for(u.s();!(n=u.n()).done;){var i=n.value;o.push(r.loaded.labels[i])}}catch(p){u.e(p)}finally{u.f()}return o}))}var m=Object.keys(s);if(m.length>1){if(r||!fn(m,Xr.used)){var d=Object.values(s);Xr.integrated=Promise.all(d).then((function(e){var t=e.map((function(e){return e.loaded.raw})),r=e.map((function(e){return e.built.features})),n=e.map((function(e){return e.built.raw}));return k.Qj(Xr.features,t,r,n)}))}Xr.integrated_results=Xr.integrated.then(function(){var r=(0,_.Z)(S().mark((function r(n){var s,o,u,i,c,l;return S().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:s=[],o=(0,D.Z)(m),r.prev=2,o.s();case 4:if((u=o.n()).done){r.next=13;break}return i=u.value,r.t0=s,r.next=9,Xr.results[i];case 9:r.t1=r.sent,r.t0.push.call(r.t0,r.t1);case 11:r.next=4;break;case 13:r.next=18;break;case 15:r.prev=15,r.t2=r.catch(2),o.e(r.t2);case 18:return r.prev=18,o.f(),r.finish(18);case 21:return c=k.Os(a,s,n,{numberOfFeatures:e,numberOfCells:t}),l=[],c.forEach((function(e){l.push(m[e])})),r.abrupt("return",l);case 25:case"end":return r.stop()}}),r,null,[[2,15,18,21]])})));return function(e){return r.apply(this,arguments)}}())}else delete Xr.integrated_results;Xr.used=m,$r=!0}()}function mn(){return dn.apply(this,arguments)}function dn(){return(dn=(0,_.Z)(S().mark((function e(){var t,r,n,a,s,o,u;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t={},r=0,n=Object.entries(Xr.results);case 2:if(!(r<n.length)){e.next=10;break}return a=(0,O.Z)(n[r],2),s=a[0],o=a[1],e.next=6,o;case 6:t[s]=e.sent;case 7:r++,e.next=2;break;case 10:if(u={per_reference:t},!("integrated_results"in Xr)){e.next=15;break}return e.next=14,Xr.integrated_results;case 14:u.integrated=e.sent;case 15:return e.abrupt("return",u);case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function hn(e){return vn.apply(this,arguments)}function vn(){return(vn=(0,_.Z)(S().mark((function e(t){var r,n,a,s,o,u,i,c,l,f;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.createGroup("cell_labelling"),(n=r.createGroup("parameters")).writeDataSet("mouse_references","String",null,Qr.mouse_references),n.writeDataSet("human_references","String",null,Qr.human_references),a=r.createGroup("results"),e.next=7,mn();case 7:for(s=e.sent,o=a.createGroup("per_reference"),u=0,i=Object.entries(s.per_reference);u<i.length;u++)c=(0,O.Z)(i[u],2),l=c[0],f=c[1],o.writeDataSet(l,"String",null,f);return"integrated"in s&&a.writeDataSet("integrated","String",null,s.integrated),e.abrupt("return");case 12:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function yn(e){if(Qr={mouse_references:[],human_references:[]},Xr.results={},"cell_labelling"in e.children){var t=e.open("cell_labelling"),r=t.open("parameters");Qr.mouse_references=r.open("mouse_references",{load:!0}).values,Qr.human_references=r.open("human_references",{load:!0}).values;for(var n=t.open("results"),a=n.open("per_reference"),s=0,o=Object.keys(a.children);s<o.length;s++){var u=o[s];Xr.results[u]=a.open(u,{load:!0}).values}"integrated"in n.children&&(Xr.integrated_results=n.open("integrated",{load:!0}).values)}return(0,x.Z)({},Qr)}var gn={results:{}},bn={selections:{}},_n=!1;function wn(e){if(Oe){bn.selections={};for(var t=0,r=Object.entries(gn.results);t<r.length;t++){var n=(0,O.Z)(r[t],2);n[0];A(n[1].raw)}gn.results={}}_n=!0}function Sn(){return{}}function kn(e){for(var t=e.createGroup("custom_selections"),r=t.createGroup("parameters").createGroup("selections"),n=0,a=Object.entries(bn.selections);n<a.length;n++){var s=(0,O.Z)(a[n],2),o=s[0],u=s[1];r.writeDataSet(String(o),"Uint8",null,u)}for(var i=t.createGroup("results").createGroup("markers"),c=0,l=Object.entries(gn.results);c<l.length;c++){var f=(0,O.Z)(l[c],2);f[0];Zr(i,f[1],1,{no_summaries:!0})}}var xn,Gn=function(){function e(t){(0,Se.Z)(this,e),this.results=t}return(0,ke.Z)(e,[{key:"effect_grabber",value:function(e,t,r,n){if(1!=t)throw"only group 1 is supported for custom marker mimics";if(1!=r)throw"only the mean effect size is supported for custom marker mimics";return T(this.results[t][e],n)}},{key:"lfc",value:function(e,t){var r=t.summary,n=t.copy;return effect_grabber("lfc",e,r,n)}},{key:"deltaDetected",value:function(e,t){var r=t.summary,n=t.copy;return effect_grabber("delta_detected",e,r,n)}},{key:"cohen",value:function(e,t){var r=t.summary,n=t.copy;return effect_grabber("cohen",e,r,n)}},{key:"auc",value:function(e,t){var r=t.summary,n=t.copy;return effect_grabber("auc",e,r,n)}},{key:"stat_grabber",value:function(e,t,r){return T(this.results[t][e],r)}},{key:"means",value:function(e,t){var r=t.copy;return stat_grabber("means",e,r)}},{key:"detected",value:function(e,t){var r=t.copy;return stat_grabber("detected",e,r)}},{key:"free",value:function(){}}]),e}();function Dn(e,t){var r=e.open("custom_selections"),n=r.open("parameters").open("selections");bn={selections:{}};for(var a=0,s=Object.keys(n.children);a<s.length;a++){var o=s[a];bn.selections[o]=n.open(o,{load:!0}).values}var u=r.open("results").open("markers");gn.results={};for(var i=0,c=Object.keys(u.children);i<c.length;i++){var l=c[i],f=Ur(u.open(l),t,{no_summaries:!0});gn.results[l]=new Gn(f)}for(var p={selections:{}},m=0,d=Object.entries(bn.selections);m<d.length;m++){var h=(0,O.Z)(d[m],2),v=h[0],y=h[1];p.selections[v]=y.slice()}return p}function On(e,t){var r=Je(),n=Z(r.numberOfColumns(),"Int32Array",gn);n.fill(0);var a=n.array();t.forEach((function(e){a[e]=1}));var s=k.y5(r,n);e in gn.results&&(A(gn.results[e].raw),delete gn.results[e]),gn.results[e]={raw:s},bn.selections[e]=t}function En(e){A(gn.results[e].raw),delete gn.results[e],delete bn.selections[e]}function Nn(e,t){return jr(gn.results[e].raw,t,1)}var Mn=null;function Tn(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;null===t&&(t=xn.result.transaction(["analysis_meta"],"readonly").objectStore("analysis_meta"));var r=t.getAll();r.onsuccess=function(){var t=r.result;t.forEach((function(e){delete e.files})),e(t)},r.onerror=function(){e(null)}}function An(e,t){return Zn.apply(this,arguments)}function Zn(){return(Zn=(0,_.Z)(S().mark((function e(t,r){return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e){var n=r.get(t);n.onsuccess=function(){void 0!==n.result?e(n.result):e(null)},n.onerror=function(){e(null)}})));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Un(e){return Promise.allSettled(e).then((function(e){var t,r=(0,D.Z)(e);try{for(r.s();!(t=r.n()).done;){if(!t.value)return!1}}catch(n){r.e(n)}finally{r.f()}return!0}))}function jn(){return Rn.apply(this,arguments)}function Rn(){return(Rn=(0,_.Z)(S().mark((function e(){return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Mn;case 2:return e.abrupt("return",new Promise((function(e){Tn(e)})));case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Cn(e,t){return Fn.apply(this,arguments)}function Fn(){return(Fn=(0,_.Z)(S().mark((function e(t,r){var n,a,s,o,u,i,c;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Mn;case 2:return n=xn.result.transaction(["file","file_meta"],"readwrite"),a=n.objectStore("file"),s=n.objectStore("file_meta"),e.next=7,An(t,s);case 7:return o=e.sent,u=null===o?0:o.count,u++,i=new Promise((function(e){var n=a.put({id:t,payload:r});n.onsuccess=function(t){e(!0)},n.onerror=function(t){e(!1)}})),c=new Promise((function(e){o.count=u;var t=s.put(o);t.onsuccess=function(t){e(!0)},t.onerror=function(t){e(!1)}})),e.abrupt("return",Un([i,c]));case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function zn(e,t,r,n){return Pn.apply(this,arguments)}function Pn(){return(Pn=(0,_.Z)(S().mark((function e(t,r,n,a){var s,o,u,i,c,l;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Mn;case 2:if(s=xn.result.transaction(["analysis","analysis_meta"],"readwrite"),o=s.objectStore("analysis"),u=s.objectStore("analysis_meta"),null!=t){e.next=10;break}return e.next=8,new Promise((function(e){return Tn(e,u)}));case 8:i=e.sent,t=String(i.length);case 10:return c=new Promise((function(e){var n=o.put({id:t,payload:r});n.onsuccess=function(t){e(!0)},n.onerror=function(t){e(!1)}})),l=new Promise((function(e){var r=u.put({id:t,files:n,time:Number(new Date),title:a});r.onsuccess=function(t){e(!0)},r.onerror=function(t){e(!1)}})),e.next=14,Un([c,l]);case 14:if(!e.sent){e.next=18;break}return e.abrupt("return",t);case 18:return e.abrupt("return",null);case 19:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function In(e){return Bn.apply(this,arguments)}function Bn(){return(Bn=(0,_.Z)(S().mark((function e(t){var r,n;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Mn;case 2:return r=xn.result.transaction(["file"],"readonly").objectStore("file"),e.next=5,An(t,r);case 5:return n=e.sent,e.abrupt("return",n.payload);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function qn(){return(qn=(0,_.Z)(S().mark((function e(t){var r,n;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Mn;case 2:return r=xn.result.transaction(["analysis"],"readonly").objectStore("analysis"),e.next=5,An(t,r);case 5:return n=e.sent,e.abrupt("return",n.payload);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Kn(e){return Ln.apply(this,arguments)}function Ln(){return(Ln=(0,_.Z)(S().mark((function e(t){var r,n,a,s,o,u;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Mn;case 2:return r=xn.result.transaction(["file","file_meta"],"readwrite"),n=r.objectStore("file"),a=r.objectStore("file_meta"),e.next=7,An(t,a);case 7:return s=e.sent,o=s.count,o--,u=[],0==o?(u.push(new Promise((function(e){var r=n.remove(t);r.onerror=function(t){e(!1)},r.onsuccess=function(t){e(!0)}}))),u.push(new Promise((function(e){var r=a.delete(t);r.onerror=function(t){e(!1)},r.onsuccess=function(t){e(!0)}})))):u.push(new Promise((function(e){s.count=o;var t=a.put(s);t.onsuccess=function(t){e(!0)},t.onerror=function(t){e(!1)}}))),e.abrupt("return",Un(u));case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Wn(){return(Wn=(0,_.Z)(S().mark((function e(t){var r,n,a,s,o,u,i,c;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Mn;case 2:return r=xn.result.transaction(["analysis","analysis_meta"],"readwrite"),n=r.objectStore("analysis"),a=r.objectStore("analysis_meta"),(s=[]).push(new Promise((function(e){var r=n.delete(t);r.onsuccess=function(t){e(!0)},r.onerror=function(t){e(!1)}}))),e.next=9,An(t,a);case 9:o=e.sent,u=(0,D.Z)(o.files);try{for(u.s();!(i=u.n()).done;)c=i.value,s.push(Kn(c))}catch(l){u.e(l)}finally{u.f()}return s.push(new Promise((function(e){var r=a.delete(t);r.onsuccess=function(t){e(!0)},r.onerror=function(t){e(!1)}}))),e.abrupt("return",Un(s));case 14:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var Yn=r(8109);function Jn(e){if(Array.isArray(e))for(var t=0;t<e.length;t++)e[t]=Jn(e[t]);else if(e instanceof Object)if("_TypedArray_class"in e){var r=e[["_TypedArray_class"]],n=e[["_TypedArray_values"]];switch(r){case"Uint8Array":case"Uint8Array":e=new Uint8Array(n.length);break;case"Int8Array":e=new Int8Array(n.length);break;case"Uint16Array":e=new Uint16Array(n.length);break;case"Int16Array":e=new Int16Array(n.length);break;case"Uint32Array":e=new Uint32Array(n.length);break;case"Int32Array":e=new Int32Array(n.length);break;case"Uint64Array":e=new Uint64Array(n.length);break;case"Int64Array":e=new Int64Array(n.length);break;case"Float32Array":e=new Float32Array(n.length);break;case"Float64Array":e=new Float64Array(n.length);break;default:throw"unrecognized TypedArray class '"+r}e.set(n)}else for(var a=0,s=Object.entries(e);a<s.length;a++){var o=(0,O.Z)(s[a],2),u=o[0],i=o[1];e[u]=Jn(i)}return e}function Hn(e,t){var r=k.ll(t),n=r.createGroup("inputs"),a=e.inputs.parameters,s=n.createGroup("parameters");s.writeDataSet("format","String",[],a.type);var o,u=s.createGroup("files"),i=(0,D.Z)(a.files.entries());try{for(i.s();!(o=i.n()).done;){var c=(0,O.Z)(o.value,2),l=c[0],f=c[1],p=u.createGroup(String(l));p.writeDataSet("type","String",[],f.type),p.writeDataSet("name","String",[],f.name),f.buffer instanceof Object?(p.writeDataSet("offset","Uint32",[],f.buffer.offset),p.writeDataSet("size","Uint32",[],f.buffer.size)):p.writeDataSet("id","String",[],f.buffer)}}catch(yt){i.e(yt)}finally{i.f()}var m=n.createGroup("results"),d=e.inputs.contents,h=Object.values(d.genes)[0].length;m.writeDataSet("dimensions","Int32",null,[h,d.num_cells]);for(var v=m.createGroup("genes"),y=0,g=Object.entries(d.genes);y<g.length;y++){var b=(0,O.Z)(g[y],2),_=b[0],w=b[1];v.writeDataSet(_,"String",null,w)}var S=r.createGroup("quality_control"),x=S.createGroup("parameters"),G=e.quality_control_metrics.parameters;x.writeDataSet("use_mito_default","Uint8",[],Number(G.use_mito_default)),x.writeDataSet("mito_prefix","String",[],G.mito_prefix);var E=e.quality_control_thresholds.parameters;x.writeDataSet("nmads","Float64",[],E.nmads);var N=S.createGroup("results"),M=N.createGroup("metrics"),T=Jn(e.quality_control_metrics.contents);M.writeDataSet("sums","Float64",null,T.sums),M.writeDataSet("detected","Int32",null,T.detected),M.writeDataSet("proportion","Float64",null,T.proportion);for(var A=N.createGroup("thresholds"),Z=Jn(e.quality_control_thresholds.contents),U=0,j=["sums","detected","proportion"];U<j.length;U++){var R=j[U];A.writeDataSet(R,"Float64",null,[Z[R]])}var C=Z.discards;N.writeDataSet("discards","Uint8",null,C);var F=r.createGroup("normalization");F.createGroup("parameters"),F.createGroup("results");var z=r.createGroup("feature_selection");z.createGroup("parameters").writeDataSet("span","Float64",[],e.feature_selection.parameters.span);for(var P=z.createGroup("results"),I=Jn(e.feature_selection.contents),B=0,q=["means","vars","fitted","resids"];B<q.length;B++){var K=q[B];P.writeDataSet(K,"Float64",null,I[K])}for(var L=r.createGroup("pca"),W=L.createGroup("parameters"),Y=e.pca.parameters,J=0,H=["num_hvgs","num_pcs"];J<H.length;J++){var V=H[J];W.writeDataSet(V,"Int32",null,Y[V])}var X=L.createGroup("results"),Q=Jn(e.pca.contents),$=Q.var_exp;X.writeDataSet("var_exp","Float64",null,$);var ee=$.length,te=Q.pcs.length/ee;X.writeDataSet("pcs","Float64",[te,ee],Q.pcs);var re=r.createGroup("neighbor_index"),ne=re.createGroup("parameters"),ae=e.pca.parameters;ne.writeDataSet("approximate","Uint8",[],Number(ae.approximate)),re.createGroup("results");var se=r.createGroup("tsne"),oe=se.createGroup("parameters"),ue=e.tsne.parameters;oe.writeDataSet("perplexity","Float64",[],ue.perplexity),oe.writeDataSet("iterations","Int32",[],ue.iterations),oe.writeDataSet("animate","Uint8",[],ue.animate);var ie=se.createGroup("results"),ce=Jn(e.tsne.contents);ie.writeDataSet("x","Float64",null,ce.x),ie.writeDataSet("y","Float64",null,ce.y);var le=r.createGroup("umap"),fe=le.createGroup("parameters"),pe=e.umap.parameters;fe.writeDataSet("num_neighbors","Int32",[],pe.num_neighbors),fe.writeDataSet("num_epochs","Int32",[],pe.num_epochs),fe.writeDataSet("min_dist","Float64",[],pe.min_dist),fe.writeDataSet("animate","Uint8",[],Number(pe.animate));var me=le.createGroup("results"),de=Jn(e.umap.contents);me.writeDataSet("x","Float64",null,de.x),me.writeDataSet("y","Float64",null,de.y);var he=r.createGroup("kmeans_cluster"),ve=he.createGroup("parameters").createDataSet("k","Int32",[]);if("kmeans_cluster"in e){var ye=e.kmeans_cluster.parameters;ve.write(ye.k)}else ve.write(10);var ge=he.createGroup("results"),be=Jn(e.kmeans_cluster.contents);"kmeans_cluster"in e&&ge.writeDataSet("clusters","Int32",null,be.clusters);var _e=r.createGroup("snn_graph_cluster"),we=_e.createGroup("parameters"),Se=e.snn_find_neighbors.parameters;we.writeDataSet("k","Int32",[],Se.k);var ke=e.snn_build_graph.parameters;we.writeDataSet("scheme","String",[],["rank","number","jaccard"][ke.scheme]);var xe=e.snn_cluster_graph.parameters;we.writeDataSet("resolution","Float64",[],xe.resolution);var Ge=_e.createGroup("results"),De=Jn(e.snn_cluster_graph.contents);Ge.writeDataSet("clusters","Int32",null,De.clusters),r.createGroup("choose_clustering").createGroup("parameters").writeDataSet("method","String",[],e.choose_clustering.parameters.method);var Oe=r.createGroup("marker_detection");Oe.createGroup("parameters");var Ee,Ne=Oe.createGroup("results").createGroup("clusters"),Me=e.marker_detection.contents,Te=(0,D.Z)(Me.entries());try{for(Te.s();!(Ee=Te.n()).done;){for(var Ae=(0,O.Z)(Ee.value,2),Ze=Ae[0],Ue=Ae[1],je=Ne.createGroup(String(Ze)),Re=Jn(Ue),Ce=0,Fe=["means","detected"];Ce<Fe.length;Ce++){var ze=Fe[Ce];je.writeDataSet(ze,"Float64",null,Re[ze])}for(var Pe=0,Ie=["lfc","delta_detected","auc","cohen"];Pe<Ie.length;Pe++)for(var Be=Ie[Pe],qe=Re[Be],Ke=je.createGroup(Be),Le=0,We=["min","mean","min-rank"];Le<We.length;Le++){var Ye=We[Le],Je="min-rank"==Ye?"min_rank":Ye;Ke.writeDataSet(Je,"Float64",null,qe[Ye])}}}catch(yt){Te.e(yt)}finally{Te.f()}for(var He=r.createGroup("custom_selections"),Ve=He.createGroup("parameters").createGroup("selections"),Xe=e.custom_marker_management.parameters,Qe=0,$e=Object.entries(Xe.selections);Qe<$e.length;Qe++){var et=(0,O.Z)($e[Qe],2),tt=et[0],rt=et[1];Ve.writeDataSet(String(tt),"Int32",null,rt)}for(var nt=He.createGroup("results").createGroup("markers"),at=0,st=Object.entries(e.custom_marker_management.contents.results);at<st.length;at++){for(var ot=(0,O.Z)(st[at],2),ut=ot[0],it=ot[1],ct=nt.createGroup(String(ut)),lt=Jn(it),ft=0,pt=["means","detected"];ft<pt.length;ft++){var mt=pt[ft];ct.writeDataSet(mt,"Float64",null,lt[mt])}for(var dt=0,ht=["lfc","delta_detected","auc","cohen"];dt<ht.length;dt++){var vt=ht[dt];ct.writeDataSet(vt,"Float64",null,lt[vt].mean)}}}function Vn(e){for(var t=new Uint8Array(8),r=0;e>0;)t[r]=e%256,e=Math.floor(e/256),r++;return t}function Xn(e){var t,r=0,n=1,a=(0,D.Z)(e);try{for(a.s();!(t=a.n()).done;){r+=n*t.value,n*=256}}catch(s){a.e(s)}finally{a.f()}return r}function Qn(e){var t={collected:[]};return e?(t.sofar=0,t.saver=function(e){t.collected.push(e.buffer);var r=t.sofar,n=e.buffer.byteLength;return t.sofar+=n,{offset:r,size:n}}):t.saver=function(){var e=(0,_.Z)(S().mark((function e(r){var n,a;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Yn.FB(new Uint8Array(r.buffer));case 2:return n=e.sent,a=r.type+"_"+r.name+"_"+r.buffer.byteLength+"_"+n,e.next=6,Cn(a,r.buffer);case 6:if(e.sent){e.next=9;break}throw"failed to save file '"+a+"' to KanaDB";case 9:return t.collected.push(a),e.abrupt("return",a);case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),t}function $n(e,t,r){var n=new ArrayBuffer(24+t.length+r),a=new Uint8Array(n),s=0,o=Vn(e);a.set(o,s),s+=o.length;var u=Vn(1001e3);a.set(u,s),s+=u.length;var i=Vn(t.length);if(a.set(i,s),24!=(s+=i.length))throw"oops - accounting error in the serialization code!";return a.set(t,s),{offset:s+=t.length,combined:n}}function ea(e,t){var r,n=0,a=(0,D.Z)(t);try{for(a.s();!(r=a.n()).done;){n+=r.value.byteLength}}catch(p){a.e(p)}finally{a.f()}var s,o=$n(0,e,n),u=o.offset,i=new Uint8Array(o.combined),c=(0,D.Z)(t);try{for(c.s();!(s=c.n()).done;){var l=s.value,f=new Uint8Array(l);i.set(f,u),u+=f.length}}catch(p){c.e(p)}finally{c.f()}return o.combined}function ta(e,t,r){return ra.apply(this,arguments)}function ra(){return(ra=(0,_.Z)(S().mark((function e(t,r,n){var a,s;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=$n(1,t,0),e.next=3,zn(null,a.combined,r,n);case 3:return s=e.sent,e.abrupt("return",s);case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function na(e,t){return aa.apply(this,arguments)}function aa(){return(aa=(0,_.Z)(S().mark((function e(t,r){var n,a,s,o,u,i,c;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=0,a=Xn(new Uint8Array(t,n,8)),n+=8,s=Xn(new Uint8Array(t,n,8)),n+=8,o=Xn(new Uint8Array(t,n,8)),n+=8,u=new Uint8Array(t,n,o),n+=o,s<1e6?(i=j.ec(u,{to:"string"}),Hn(JSON.parse(i),r)):k.NC(r,u),c={},0!=a){e.next=17;break}c.remaining=new Uint8Array(t,n,t.byteLength-n),c.loader=function(e,t){return c.remaining.slice(e,e+t)},c.embedded=!0,e.next=23;break;case 17:if(1!=a){e.next=22;break}c.loader=In,c.embedded=!1,e.next=23;break;case 22:throw"unsupported format type";case 23:return e.abrupt("return",c);case 24:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function sa(e,t,r){var n=[];U(e,n),postMessage({type:"".concat(t,"_DATA"),resp:e,msg:"Success: "+r},n)}var oa,ua="inputs",ia="quality_control",ca="normalizaton",la="feature_selecton",fa="pca",pa="neighbor_index",ma="tsne",da="umap",ha="kmeans_cluster",va="snn_cluster_graph",ya="choose_clustering",ga="marker_detection",ba="cell_labelling",_a="custom_marker_management";function wa(e,t){return Sa.apply(this,arguments)}function Sa(){return(Sa=(0,_.Z)(S().mark((function e(t,r){var n,a,s;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n="temp.h5",e.prev=1,s=k.ll(n),e.next=5,fe(s,t,r);case 5:return Ze(s),We(s),rt(s),mt(s),kt(s),e.next=12,mr(s);case 12:return e.next=14,Or(s);case 14:return qt(s),Zt(s),Vt(s),Pr(s),e.next=20,hn(s);case 20:kn(s),a=k.pJ(n);case 22:return e.prev=22,k.ki(n)&&k.Yd(n),e.finish(22);case 25:return e.abrupt("return",a);case 26:case"end":return e.stop()}}),e,null,[[1,,22,25]])})))).apply(this,arguments)}function ka(e,t,r){return xa.apply(this,arguments)}function xa(){return(xa=(0,_.Z)(S().mark((function e(t,r,n){var a,s,_,w,x,G,D,O,E,N,M,T,A,Z,U,j;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=function(e,t,r){sa(e.results(),t,r)},s=function(e,t,r){e.results().then((function(e){sa(e,t,r)}))},_={},w=new k.pT(t),e.next=6,me(w,r,n);case 6:return x=e.sent,_.files={format:"kana",files:[]},a(o,ua,"Reloaded count matrix"),G=Re(w),a(u,ia,"Reloaded QC metrics"),_.qc={"qc-usemitodefault":G.use_mito_default,"qc-mito":G.mito_prefix,"qc-nmads":G.nmads},a(i,ca,"Reloaded log-normalization"),D=at(w,x),a(c,la,"Reloaded variance modelling statistics"),_.fSelection={"fsel-span":D.span},O=ht(w),a(l,fa,"Reloaded principal components"),_.pca={"pca-hvg":O.num_hvgs,"pca-npc":O.num_pcs,"pca-correction":O.block_method},E=xt(w),a(f,pa,"Reloaded neighbor search index"),_.cluster={"clus-approx":E.approximate},N=hr(w),s(h,ma,"t-SNE reloaded"),_.tsne={"tsne-perp":N.perplexity,"tsne-iter":N.iterations,animate:N.animate},M=Nr(w),s(v,da,"UMAP reloaded"),_.umap={"umap-epochs":M.num_epochs,"umap-nn":M.num_neighbors,"umap-min_dist":M.min_dist,animate:M.animate},T=Lt(w),a(m,ha,"K-means clustering reloaded"),_.cluster["kmeans-k"]=T.k,A=jt(w),a(p,va,"SNN graph clustering reloaded"),_.cluster["clus-k"]=A.k,_.cluster["clus-scheme"]=A.scheme,_.cluster["clus-res"]=A.resolution,Z=Xt(w),a(d,ya,"Clustering of interest chosen"),_.cluster["clus-method"]=Z.method,qr(w,x),a(y,ga,"Reloaded per-cluster markers"),U=yn(w),s(g,ba,"Reloaded cell type labels"),_.annotateCells={"annotateCells-human_references":U.human_references,"annotateCells-mouse_references":U.mouse_references},j=Dn(w,x),a(b,_a,"Pruning of custom markers finished"),_["custom-selections"]=j,e.abrupt("return",_);case 49:case"end":return e.stop()}}),e)})))).apply(this,arguments)}onmessage=function(e){var t=e.data;if("INIT"==t.type){var r=Math.round(2*navigator.hardwareConcurrency/3),n=k.j2({numberOfThreads:r});n.then((function(e){postMessage({type:t.type,msg:"Success: ScranJS/WASM initialized"})}));var a=Mn=new Promise((function(e){(xn=indexedDB.open("KanaDB",2)).onupgradeneeded=function(e){var t=e.target.result;try{t.deleteObjectStore("analysis")}catch(e){}try{t.deleteObjectStore("analysis_meta")}catch(e){}try{t.deleteObjectStore("file")}catch(e){}try{t.deleteObjectStore("file_meta")}catch(e){}t.createObjectStore("analysis",{keyPath:"id"}),t.createObjectStore("analysis_meta",{keyPath:"id"}),t.createObjectStore("file",{keyPath:"id"}),t.createObjectStore("file_meta",{keyPath:"id"})},xn.onsuccess=function(){Tn(e)},xn.onerror=function(){e(null)}}));a.then((function(e){null!==e?postMessage({type:"KanaDB_store",resp:e,msg:"Success"}):(console.error(error),postMessage({type:"KanaDB_ERROR",msg:"Fail: Cannot initialize DB"}))}));var s=or(),w=_r();oa=Promise.all([n,a,s,w])}else if("RUN"==t.type)oa.then((function(e){!function(e){var t=function(e,t,r){e.changed&&sa(e.results(),t,r)},r=function(e,t,r){e.changed&&e.results().then((function(e){sa(e,t,r)}))};ce(e.files.files,e.files.batch),t(o,ua,"Count matrix loaded"),Ne(e.params.qc["qc-usemitodefault"],e.params.qc["qc-mito"],e.params.qc["qc-nmads"]),t(u,ia,"Applying quality control filters"),Ke(),t(i,ca,"Log-normalization completed"),$e(e.params.fSelection["fsel-span"]),t(c,la,"Variance modelling completed"),ft(e.params.pca["pca-hvg"],e.params.pca["pca-npc"],e.params.pca["pca-correction"]),t(l,fa,"Principal components analysis completed"),wt(e.params.cluster["clus-approx"]),t(f,pa,"Neighbor search index constructed"),cr(e.params.tsne["tsne-perp"],e.params.tsne["tsne-iter"],e.params.tsne.animate),r(h,ma,"t-SNE completed"),kr(e.params.umap["umap-nn"],e.params.umap["umap-epochs"],e.params.umap["umap-min_dist"],e.params.umap.animate),r(v,da,"UMAP completed");var n=e.params.cluster["clus-method"];It("kmeans"==n,e.params.cluster["kmeans-k"]),t(m,ha,"K-means clustering completed"),Tt("snn_graph"==n,e.params.cluster["clus-k"],e.params.cluster["clus-scheme"],e.params.cluster["clus-res"]),t(p,va,"SNN graph clustering completed"),Jt(e.params.cluster["clus-method"]),t(d,ya,"Clustering of interest chosen"),Fr(),t(y,ga,"Marker detection complete"),pn(e.params.annotateCells["annotateCells-human_references"],e.params.annotateCells["annotateCells-mouse_references"]),r(g,ba,"Cell type labelling complete"),wn(),t(b,_a,"Pruning of custom markers finished")}(t.payload)})).catch((function(e){console.error(e),postMessage({type:"run_ERROR",msg:e.toString()})}));else if("LOAD"==t.type){var x=z("state_",".h5"),G=t.payload.files.files;if("kana"==G[Object.keys(G)[0]].format){var D=G[Object.keys(G)[0]].file[0];oa.then(function(){var e=(0,_.Z)(S().mark((function e(t){var r,n,a,s;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new FileReaderSync,n=r.readAsArrayBuffer(D),e.prev=2,e.next=5,na(n,x);case 5:return a=e.sent,e.next=8,ka(x,a.loader,a.embedded);case 8:s=e.sent,postMessage({type:"loadedParameters",resp:s});case 10:return e.prev=10,k.ki(x)&&k.Yd(x),e.finish(10);case 13:case"end":return e.stop()}}),e,null,[[2,,10,13]])})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error(e),postMessage({type:"load_ERROR",msg:e.toString()})}))}else if("kanadb"==G[Object.keys(G)[0]].format){(function(e){return qn.apply(this,arguments)})(E=G[Object.keys(G)[0]].file).then(function(){var e=(0,_.Z)(S().mark((function e(t){var r,n;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t){e.next=4;break}postMessage({type:"KanaDB_ERROR",msg:"Fail: cannot load analysis ID '".concat(E,"'")}),e.next=15;break;case 4:return e.prev=4,e.next=7,na(t,x);case 7:return r=e.sent,e.next=10,ka(x,r.loader,r.embedded);case 10:n=e.sent,postMessage({type:"loadedParameters",resp:n});case 12:return e.prev=12,k.ki(x)&&k.Yd(x),e.finish(12);case 15:case"end":return e.stop()}}),e,null,[[4,,12,15]])})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error(e),postMessage({type:"load_ERROR",msg:e.toString()})}))}}else if("EXPORT"==t.type)oa.then(function(){var e=(0,_.Z)(S().mark((function e(t){var r,n,a;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Qn(!0);case 2:return r=e.sent,e.next=5,wa(r.saver,!0);case 5:return n=e.sent,e.next=8,ea(n,r.collected);case 8:a=e.sent,postMessage({type:"exportState",resp:a,msg:"Success: application state exported"},[a]);case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error(e),postMessage({type:"export_ERROR",msg:e.toString()})}));else if("SAVEKDB"==t.type){var O=t.payload.title;oa.then(function(){var e=(0,_.Z)(S().mark((function e(t){var r,n,a;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Qn(!1);case 2:return r=e.sent,e.next=5,wa(r.saver,!1);case 5:return n=e.sent,e.next=8,ta(n,r.collected,O);case 8:if(e.sent,null===E){e.next=16;break}return e.next=12,jn();case 12:a=e.sent,postMessage({type:"KanaDB_store",resp:a,msg:"Success: Saved analysis to cache (".concat(E,")")}),e.next=18;break;case 16:console.error(error),postMessage({type:"KanaDB_ERROR",msg:"Fail: Cannot save analysis to cache (".concat(E,")")});case 18:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error(e),postMessage({type:"export_ERROR",msg:e.toString()})}))}else if("REMOVEKDB"==t.type){var E;(function(e){return Wn.apply(this,arguments)})(E=t.payload.id).then(function(){var e=(0,_.Z)(S().mark((function e(t){var r;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=7;break}return e.next=3,jn();case 3:r=e.sent,postMessage({type:"KanaDB_store",resp:r,msg:"Success: Removed file from cache (".concat(E,")")}),e.next=9;break;case 7:console.error(error),postMessage({type:"KanaDB_ERROR",msg:"fail: cannot remove file from cache (".concat(E,")")});case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())}else"PREFLIGHT_INPUT"==t.type?oa.then((function(e){var r=we(t.payload.files.files);postMessage({type:"PREFLIGHT_INPUT_DATA",resp:r,msg:"Success: PREFLIGHT_INPUT done"})})).catch((function(e){console.error(e),postMessage({type:"run_ERROR",msg:e.toString()})})):"getMarkersForCluster"==t.type?oa.then((function(e){var r=t.payload.cluster,n=Kr(t.payload.rank_type,r),a=[];U(n,a),postMessage({type:"setMarkersForCluster",resp:n,msg:"Success: GET_MARKER_GENE done"},a)})):"getGeneExpression"==t.type?oa.then((function(e){var r=t.payload.gene,n=He(r);postMessage({type:"setGeneExpression",resp:{gene:r,expr:n},msg:"Success: GET_GENE_EXPRESSION done"},[n.buffer])})):"computeCustomMarkers"==t.type?oa.then((function(e){On(t.payload.id,t.payload.selection),postMessage({type:"computeCustomMarkers",msg:"Success: COMPUTE_CUSTOM_MARKERS done"})})):"getMarkersForSelection"==t.type?oa.then((function(e){var r=Nn(t.payload.cluster,t.payload.rank_type),n=[];U(r,n),postMessage({type:"setMarkersForCustomSelection",resp:r,msg:"Success: GET_MARKER_GENE done"},n)})):"removeCustomMarkers"==t.type?oa.then((function(e){En(t.payload.id)})):"animateTSNE"==t.type?oa.then(function(){var e=(0,_.Z)(S().mark((function e(t){return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,vr();case 2:return e.next=4,pr();case 4:sa(e.sent,"tsne","Resending t-SNE coordinates");case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()):"animateUMAP"==t.type?oa.then(function(){var e=(0,_.Z)(S().mark((function e(t){return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Mr();case 2:return e.next=4,Dr();case 4:sa(e.sent,"umap","Resending UMAP coordinates");case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()):"getAnnotation"==t.type?oa.then((function(e){var r=t.payload.annotation,n=ge(r);if(!1!==t.payload.unfiltered){var a=new Set(Fe().array()),s=function(e,t){return!a.has(t)};"factor"in n?n.factor=n.factor.filter(s):n=n.filter(s)}postMessage({type:"setAnnotation",resp:{annotation:r,values:{index:n.index,factor:n.factor}},msg:"Success: GET_ANNOTATION done"},[n.factor.buffer])})):console.error("MIM:::msg type incorrect")}}},t={};function r(n){var a=t[n];if(void 0!==a)return a.exports;var s=t[n]={exports:{}};return e[n](s,s.exports,r),s.exports}r.m=e,r.x=function(){var e=r.O(void 0,[275,169],(function(){return r(1203)}));return e=r.O(e)},function(){var e=[];r.O=function(t,n,a,s){if(!n){var o=1/0;for(l=0;l<e.length;l++){n=e[l][0],a=e[l][1],s=e[l][2];for(var u=!0,i=0;i<n.length;i++)(!1&s||o>=s)&&Object.keys(r.O).every((function(e){return r.O[e](n[i])}))?n.splice(i--,1):(u=!1,s<o&&(o=s));if(u){e.splice(l--,1);var c=a();void 0!==c&&(t=c)}}return t}s=s||0;for(var l=e.length;l>0&&e[l-1][2]>s;l--)e[l]=e[l-1];e[l]=[n,a,s]}}(),r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,{a:t}),t},r.d=function(e,t){for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.f={},r.e=function(e){return Promise.all(Object.keys(r.f).reduce((function(t,n){return r.f[n](e,t),t}),[]))},r.u=function(e){return"static/js/"+e+"."+{139:"dc8b2a81",169:"83dd5f91",275:"13442405",495:"d0c00727",653:"4b659070"}[e]+".chunk.js"},r.miniCssF=function(e){},r.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}(),r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.p="/kana/",function(){r.b=self.location+"/../../../";var e={203:1};r.f.i=function(t,n){e[t]||importScripts(r.p+r.u(t))};var t=self.webpackChunkkana=self.webpackChunkkana||[],n=t.push.bind(t);t.push=function(t){var a=t[0],s=t[1],o=t[2];for(var u in s)r.o(s,u)&&(r.m[u]=s[u]);for(o&&o(r);a.length;)e[a.pop()]=1;n(t)}}(),function(){var e=r.x;r.x=function(){return Promise.all([r.e(275),r.e(169)]).then(e)}}();r.x()}();
//# sourceMappingURL=203.332f0677.chunk.js.map