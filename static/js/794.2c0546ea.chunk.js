!function(){"use strict";var e={7794:function(e,t,r){var n={};r.r(n),r.d(n,{changed:function(){return z},compute:function(){return W},fetchAnnotations:function(){return ee},fetchCountMatrix:function(){return X},fetchGeneTypes:function(){return $},fetchGenes:function(){return Q},results:function(){return L},serialize:function(){return J},unserialize:function(){return V}});var a={};r.r(a),r.d(a,{changed:function(){return oe},compute:function(){return ie},fetchDiscards:function(){return ye},fetchFilteredMatrix:function(){return ge},fetchSums:function(){return he},results:function(){return fe},serialize:function(){return pe},unserialize:function(){return ve}});var s={};r.r(s),r.d(s,{changed:function(){return _e},compute:function(){return Se},fetchExpression:function(){return Me},fetchNormalizedMatrix:function(){return De},results:function(){return xe},serialize:function(){return ke},unserialize:function(){return Ge}});var o={};r.r(o),r.d(o,{changed:function(){return Oe},compute:function(){return Te},fetchResiduals:function(){return ze},fetchSortedResiduals:function(){return Ce},results:function(){return Ue},serialize:function(){return Ze},unserialize:function(){return je}});var u={};r.r(u),r.d(u,{changed:function(){return Ie},compute:function(){return qe},fetchPCs:function(){return Ye},results:function(){return Ke},serialize:function(){return We},unserialize:function(){return Je}});var i={};r.r(i),r.d(i,{changed:function(){return Xe},compute:function(){return $e},fetchIndex:function(){return nt},rawCompute:function(){return Qe},results:function(){return et},serialize:function(){return tt},unserialize:function(){return rt}});var c={};r.r(c),r.d(c,{changed:function(){return ot},compute:function(){return ct},fetchClustersAsWasmArray:function(){return it},results:function(){return lt},serialize:function(){return ft},unserialize:function(){return mt},valid:function(){return ut}});var l={};r.r(l),r.d(l,{changed:function(){return ht},compute:function(){return bt},fetchClustersAsWasmArray:function(){return gt},results:function(){return _t},serialize:function(){return wt},unserialize:function(){return xt},valid:function(){return yt}});var f={};r.r(f),r.d(f,{changed:function(){return Gt},compute:function(){return Dt},fetchClustersAsWasmArray:function(){return Ot},results:function(){return Mt},serialize:function(){return Et},unserialize:function(){return Nt}});var p={};r.r(p),r.d(p,{animate:function(){return Yt},changed:function(){return Ft},compute:function(){return It},initialize:function(){return zt},results:function(){return Kt},serialize:function(){return Wt},unserialize:function(){return Jt}});var m={};r.r(m),r.d(m,{animate:function(){return ir},changed:function(){return $t},compute:function(){return tr},initialize:function(){return Qt},results:function(){return ar},serialize:function(){return sr},unserialize:function(){return ur}});var d={};r.r(d),r.d(d,{changed:function(){return vr},compute:function(){return hr},fetchGroupMeans:function(){return kr},fetchGroupResults:function(){return Sr},numberOfGroups:function(){return xr},results:function(){return yr},serialize:function(){return gr},unserialize:function(){return wr}});var v={};r.r(v),r.d(v,{changed:function(){return Tr},compute:function(){return qr},results:function(){return Kr},serialize:function(){return Lr},unserialize:function(){return Yr}});var h={};r.r(h),r.d(h,{addSelection:function(){return an},changed:function(){return Xr},compute:function(){return Qr},fetchResults:function(){return on},removeSelection:function(){return sn},results:function(){return $r},serialize:function(){return en},unserialize:function(){return nn}});var y=r(5861),g=r(7757),b=r.n(g),_=r(9451),w=r(1413),S=r(3324),x=r(7762),k=r(6737);function G(e,t){if(t)for(var r=0,n=Object.keys(e);r<n.length;r++){var a=n[r];e[a]=e[a].slice()}}function D(e){return e||"view"}function M(e,t){return e instanceof k.PQ?"view"==t?e.view():t?e.slice():e.array():!0===t?e.slice():e}function E(e){void 0!==e&&null!==e&&e.free()}function N(e,t){return JSON.stringify(e)!=JSON.stringify(t)}function O(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"buffer",a=!0;if(n in r){var s=r[n];s.size!=e||s.constructor.className!=t?s.free():a=!1}if(a)switch(t){case"Uint8Array":r[n]=_.TS(e);break;case"Int32Array":r[n]=_.Wf(e);break;case"Float64Array":r[n]=_.RJ(e);break;default:throw"allocating '"+t+"' not yet supported"}return r[n]}function T(e,t){if(Array.isArray(e)){var r,n=(0,x.Z)(e);try{for(n.s();!(r=n.n()).done;){T(r.value,t)}}catch(u){n.e(u)}finally{n.f()}}else if(e.constructor==Object)for(var a=0,s=Object.entries(e);a<s.length;a++){var o=(0,S.Z)(s[a],2);o[0];T(o[1],t)}else if(ArrayBuffer.isView(e)){if(!(e.buffer instanceof ArrayBuffer))throw"only ArrayBuffers should be in the message payload";t.push(e.buffer)}}function A(e){return"object"===typeof e&&!1===Array.isArray(e)}var U=r(1414),Z=r(8308),R={},j={},C={},z=!1;function F(e){for(var t=[],r=0;r<e;r++)t.push("Gene ".concat(r+1));return{id:t}}function P(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"\t",n=t.name.split(".").pop();"gz"==n&&(e=Z.ec(e));var a=new TextDecoder,s=a.decode(e),o=U.Z(r),u=o.parseRows(s);return u}function I(e){E(R.matrix);var t=e.filter((function(e){return"mtx"==e.type}))[0],r=new Uint8Array(t.buffer),n="gz"==t.name.split(".").pop();if(R.matrix=_.DK(r,{compressed:n}),1==(a=e.filter((function(e){return"genes"==e.type}))).length){var a=a[0],s=P(new Uint8Array(a.buffer),a);if(s.length!=R.matrix.numberOfRows())throw"number of matrix rows is not equal to the number of genes in '"+a.name+"'";var o=[],u=[];s.forEach((function(e){o.push(e[0]),u.push(e[1])})),R.genes={id:o,symbol:u}}else R.genes=F(R.matrix.numberOfRows());if(_.dc(R.matrix,R.genes),1==(i=e.filter((function(e){return"annotations"==e.type}))).length){var i=i[0],c=P(new Uint8Array(i.buffer),i),l=R.matrix.numberOfColumns()-c.length,f=!1;if(0===l)f=!1;else{if(-1!==l)throw"number of annotations rows is not equal to the number of cells in '"+i.name+"'";f=!0}var p=[];f?p=c.shift():c[0].forEach((function(e,t){p.push("Column_".concat(t+1))})),R.annotations={},p.forEach((function(e,t){R.annotations[e]=c.map((function(e){return e[t]}))}))}else R.annotations=null}function B(e){E(R.matrix);var t=e[0],r=t.name;_.NC(r,new Uint8Array(t.buffer));try{R.matrix=_.EF(r,"matrix"),R.genes=null;var n=_.JM(r);if("features"in n.matrix){var a=n.matrix.features;"id"in a&&"string dataset"===a.id&&(R.genes={id:_.dO(r,"matrix/features/id").contents},"name"in a&&"string dataset"===a.name&&(R.genes.names=_.dO(r,"matrix/features/name").contents))}R.annotations=null}finally{_.Yd(r)}null===R.genes&&(R.genes=F(R.matrix.numberOfRows())),_.dc(R.matrix,R.genes)}function q(e,t){E(R.matrix);var r=e[0],n=r.name;_.NC(n,new Uint8Array(r.buffer));try{R.matrix=_.EF(n,"X");var a=_.JM(n);if(R.genes=null,"var"in a){var s=a.var;if(A(s)&&"_index"in s&&"string dataset"==s._index){R.genes={_index:_.dO(n,"var/_index").contents};for(var o=0,u=Object.entries(s);o<u.length;o++){var i=(0,S.Z)(u[o],2),c=i[0];"string dataset"===i[1]&&(c.match(/name/i)||c.match(/symb/i))&&(R.genes[c]=_.dO(n,"var/".concat(c)).contents)}}}if(R.annotations=null,"obs"in a){var l=a.obs;if(R.annotations={},A(l)){"_index"in l&&"string dataset"==l._index&&(R.annotations._index=_.dO(n,"obs/_index").contents);for(var f=0,p=Object.entries(l);f<p.length;f++){var m=(0,S.Z)(p[f],2),d=m[0],v=m[1];if("string dataset"===v||"integer dataset"===v||"float dataset"===v){var h=_.dO(n,"obs/".concat(d)).contents;if("__categories"in l&&"string dataset"==l.__categories[d]){var y=_.dO(n,"obs/__categories/".concat(d)).contents;R.annotations[d]={type:"factor",index:y,factor:h}}else R.annotations[d]=h}}}}}finally{_.Yd(n)}null===R.genes&&(R.genes=F(R.matrix.numberOfRows())),_.dc(R.matrix,R.genes)}function K(e,t){for(var r=new FileReaderSync,n=0;n<2;n++){var a,s={format:t,files:[]};a=0==n?function(e){return e.size}:function(e){return r.readAsArrayBuffer(e)};var o,u=(0,x.Z)(e.file);try{for(u.s();!(o=u.n()).done;){var i=o.value;s.files.push({type:"h5",name:i.name,buffer:a(i)})}}catch(c){u.e(c)}finally{u.f()}if(0==n){if(!N(C,s))return void(z=!1);C=s,z=!0}else j=s,"10X"==t?B(s.files):q(s.files)}}function W(e,t){switch(e){case"mtx":!function(e){for(var t=new FileReaderSync,r=0;r<2;r++){var n,a={format:"MatrixMarket",files:[]};n=0==r?function(e){return e.size}:function(e){return t.readAsArrayBuffer(e)};var s,o=(0,x.Z)(e.mtx);try{for(o.s();!(s=o.n()).done;){var u=s.value;a.files.push({type:"mtx",name:u.name,buffer:n(u)})}}catch(l){o.e(l)}finally{o.f()}if(null!==e.gene){if(1!==e.gene.length)throw"expected no more than one gene file";var i=e.gene[0];a.files.push({type:"genes",name:i.name,buffer:n(i)})}if(null!==e.barcode){if(1!==e.barcode.length)throw"expected no more than one cell annotation file";var c=e.barcode[0];a.files.push({type:"annotations",name:c.name,buffer:n(c)})}if(0==r){if(!N(C,a))return void(z=!1);C=a,z=!0}else j=a,I(a.files)}}(t);break;case"hdf5":case"tenx":K(t,"10X");break;case"h5ad":K(t,"H5AD");break;case"kana":break;default:throw"unknown matrix file extension: '"+e+"'"}}function L(){var e={dimensions:{num_genes:R.matrix.numberOfRows(),num_cells:R.matrix.numberOfColumns()},genes:(0,w.Z)({},R.genes)};return R.annotations&&(e.annotations=Object.keys(R.annotations)),e}function J(e,t,r){return Y.apply(this,arguments)}function Y(){return(Y=(0,y.Z)(b().mark((function e(t,r,n){var a,s,o,u,i,c,l,f,p,m,d,v,h;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=t.createGroup("inputs"),(s=a.createGroup("parameters")).writeDataSet("format","String",[],j.format),o=s.createGroup("files"),0,u=(0,x.Z)(j.files.entries()),e.prev=6,u.s();case 8:if((i=u.n()).done){e.next=19;break}return c=(0,S.Z)(i.value,2),l=c[0],f=c[1],(p=o.createGroup(String(l))).writeDataSet("type","String",[],f.type),p.writeDataSet("name","String",[],f.name),e.next=15,r(f);case 15:m=e.sent,n?(p.writeDataSet("offset","Uint32",[],m.offset),p.writeDataSet("size","Uint32",[],m.size)):p.writeDataSet("id","String",[],m);case 17:e.next=8;break;case 19:e.next=24;break;case 21:e.prev=21,e.t0=e.catch(6),u.e(e.t0);case 24:return e.prev=24,u.f(),e.finish(24);case 27:return d=R.matrix.permutation({copy:"view"}),v=[R.matrix.numberOfRows(),R.matrix.numberOfColumns()],(h=a.createGroup("results")).writeDataSet("dimensions","Int32",null,v),h.writeDataSet("permutation","Int32",null,d),e.abrupt("return");case 33:case"end":return e.stop()}}),e,null,[[6,21,24,27]])})))).apply(this,arguments)}function V(e,t,r){return H.apply(this,arguments)}function H(){return(H=(0,y.Z)(b().mark((function e(t,r,n){var a,s,o,u,i,c,l,f,p,m,d,v,h,y,g,w,S,x,k,G,D,M,E,N,O,T;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=t.open("inputs"),s=a.open("parameters"),o=s.open("files"),u=o.children,i=new Array(u.length),c=0,l=Object.keys(u);case 6:if(!(c<l.length)){e.next=28;break}for(f=l[c],p=o.open(f),m={},d=0,v=["type","name"];d<v.length;d++)h=v[d],y=p.open(h,{load:!0}),m[h]=y.values[0];if(n){e.next=18;break}return g=p.open("id",{load:!0}),e.next=15,r(g.values[0]);case 15:m.buffer=e.sent,e.next=23;break;case 18:for(w={},S=0,x=["offset","size"];S<x.length;S++)k=x[S],G=p.open(k,{load:!0}),w[k]=G.values[0];return e.next=22,r(w.offset,w.size);case 22:m.buffer=e.sent;case 23:D=Number(f),i[D]=m;case 25:c++,e.next=6;break;case 28:if("MatrixMarket"!=(M=s.open("format",{load:!0}).values[0])){e.next=33;break}I(i),e.next=46;break;case 33:if("H5AD"!=M){e.next=37;break}q(i),e.next=46;break;case 37:if("10X"!=M){e.next=41;break}B(i),e.next=46;break;case 41:if("HDF5"!=M){e.next=45;break}i[0].name.match(/h5ad$/i)?q(i):B(i),e.next=46;break;case 45:throw'unrecognized count matrix format "'.concat(M,'"');case 46:return j={format:M,files:i},E=a.open("results"),N=null,"permutation"in E.children&&(O=E.open("permutation",{load:!0}),N=_.k_(R.matrix,O.values)),T=null!==N?function(e){var t=e.slice();e.forEach((function(r,n){t[n]=e[N[n]]})),e.set(t)}:function(e){},e.abrupt("return",T);case 52:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function X(){return R.matrix}function Q(){return R.genes}function $(){if(!("gene_types"in R)){for(var e={},t=Q(),r=0,n=Object.entries(t);r<n.length;r++){var a=(0,S.Z)(n[r],2),s=a[0],o=a[1];e[s]=_.gn(o)}R.gene_types=e}return R.gene_types}function ee(e){var t=R.annotations;R.matrix.numberOfColumns();if(!(e in t))throw"column ".concat(e," does not exist in col.tsv");if(A(t[e])&&"type"in t[e])return t[e];var r={},n=new Uint8Array(asize);return t[e].map((function(e,t){e in r||(r[e]=Object.keys(r).length),n[t]=r[e]})),{index:Object.keys(r),factor:n}}var te=r(5671),re=r(3144),ne={};ne.ensembl=new Set(["ENSMUSG00000064336","ENSMUSG00000064337","ENSMUSG00000064338","ENSMUSG00000064339","ENSMUSG00000064340","ENSMUSG00000064341","ENSMUSG00000064342","ENSMUSG00000064343","ENSMUSG00000064344","ENSMUSG00000064345","ENSMUSG00000064346","ENSMUSG00000064347","ENSMUSG00000064348","ENSMUSG00000064349","ENSMUSG00000064350","ENSMUSG00000064351","ENSMUSG00000064352","ENSMUSG00000064353","ENSMUSG00000064354","ENSMUSG00000064355","ENSMUSG00000064356","ENSMUSG00000064357","ENSMUSG00000064358","ENSMUSG00000064359","ENSMUSG00000064360","ENSMUSG00000064361","ENSMUSG00000064363","ENSMUSG00000064364","ENSMUSG00000064365","ENSMUSG00000064366","ENSMUSG00000064367","ENSMUSG00000064368","ENSMUSG00000064369","ENSMUSG00000064370","ENSMUSG00000064371","ENSMUSG00000064372","ENSMUSG00000065947","ENSG00000198695","ENSG00000198712","ENSG00000198727","ENSG00000198763","ENSG00000198786","ENSG00000198804","ENSG00000198840","ENSG00000198886","ENSG00000198888","ENSG00000198899","ENSG00000198938","ENSG00000209082","ENSG00000210049","ENSG00000210077","ENSG00000210082","ENSG00000210100","ENSG00000210107","ENSG00000210112","ENSG00000210117","ENSG00000210127","ENSG00000210135","ENSG00000210140","ENSG00000210144","ENSG00000210151","ENSG00000210154","ENSG00000210156","ENSG00000210164","ENSG00000210174","ENSG00000210176","ENSG00000210184","ENSG00000210191","ENSG00000210194","ENSG00000210195","ENSG00000210196","ENSG00000211459","ENSG00000212907","ENSG00000228253"]),ne.symbol=new Set(["mt-Tf","mt-Rnr1","mt-Tv","mt-Rnr2","mt-Tl1","mt-Nd1","mt-Ti","mt-Tq","mt-Tm","mt-Nd2","mt-Tw","mt-Ta","mt-Tn","mt-Tc","mt-Ty","mt-Co1","mt-Ts1","mt-Td","mt-Co2","mt-Tk","mt-Atp8","mt-Atp6","mt-Co3","mt-Tg","mt-Nd3","mt-Tr","mt-Nd4","mt-Th","mt-Ts2","mt-Tl2","mt-Nd5","mt-Nd6","mt-Te","mt-Cytb","mt-Tt","mt-Tp","mt-Nd4l","MT-ND6","MT-CO2","MT-CYB","MT-ND2","MT-ND5","MT-CO1","MT-ND3","MT-ND4","MT-ND1","MT-ATP6","MT-CO3","MT-TL1","MT-TF","MT-TV","MT-RNR2","MT-TI","MT-TQ","MT-TM","MT-TW","MT-TA","MT-TN","MT-TC","MT-TY","MT-TS1","MT-TD","MT-TK","MT-TG","MT-TR","MT-TH","MT-TS2","MT-TL2","MT-TE","MT-TT","MT-TP","MT-RNR1","MT-ND4L","MT-ATP8"]);var ae={},se={},oe=!1;function ue(){var e=X(),t=ye();E(ae.matrix),ae.matrix=_.b_(e,t)}function ie(e,t,r){var n=z||e!==se.use_mito_default||t!==se.mito_prefix,a=n||r!==se.nmads,s=a;ae.filters instanceof de&&s&&(a=!0),ae.metrics instanceof me&&(s||a)&&(n=!0),n&&(!function(e,t){var r=X(),n=O(1*r.numberOfRows(),"Uint8Array",ae,"metrics_buffer");n.fill(0);for(var a=Q(),s=n.array(),o=0,u=Object.entries(a);o<u.length;o++){var i=(0,S.Z)(u[o],2),c=(i[0],i[1]);if(e)c.forEach((function(e,t){(ne.symbol.has(e)||ne.ensembl.has(e))&&(s[t]=1)}));else{var l=t.toLowerCase();c.forEach((function(e,t){e.toLowerCase().startsWith(l)&&(s[t]=1)}))}}E(ae.metrics),ae.metrics=_.i4(r,n)}(e,t),se.use_mito_default=e,se.mito_prefix=t),a&&(!function(e){E(ae.filters),ae.filters=_.rU(ae.metrics,{numberOfMADs:e})}(r),se.nmads=r),s&&(ue(),oe=!0)}function ce(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return e=D(e),{sums:ae.metrics.sums({copy:e}),detected:ae.metrics.detected({copy:e}),proportion:ae.metrics.subsetProportions(0,{copy:e})}}function le(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return e=D(e),{sums:ae.filters.thresholdsSums({copy:e}),detected:ae.filters.thresholdsDetected({copy:e}),proportion:ae.filters.thresholdsSubsetProportions(0,{copy:e})}}function fe(){for(var e=ce(),t=le(),r={},n=0,a=Object.keys(e);n<a.length;n++){var s=a[n],o=-1/0,u=1/0;e[s].forEach((function(e){o<e&&(o=e),u>e&&(u=e)})),r[s]=[u,o]}var i=0;return"matrix"in ae?i=ae.matrix.numberOfColumns():ye().array().forEach((function(e){0==e&&i++})),{data:e,ranges:r,thresholds:t,retained:i}}function pe(e){var t=e.createGroup("quality_control"),r=t.createGroup("parameters");r.writeDataSet("use_mito_default","Uint8",[],Number(se.use_mito_default)),r.writeDataSet("mito_prefix","String",[],se.mito_prefix),r.writeDataSet("nmads","Float64",[],se.nmads);var n=t.createGroup("results"),a=n.createGroup("metrics"),s=ce(!1);a.writeDataSet("sums","Float64",null,s.sums),a.writeDataSet("detected","Int32",null,s.detected),a.writeDataSet("proportion","Float64",null,s.proportion);for(var o=n.createGroup("thresholds"),u=le(!1),i=0,c=["sums","detected","proportion"];i<c.length;i++){var l=c[i],f=u[l];o.writeDataSet(l,"Float64",null,f)}var p=ye();n.writeDataSet("discards","Uint8",null,p)}var me=function(){function e(t,r,n){(0,te.Z)(this,e),this.sums_=t,this.detected_=r,this.proportion_=n}return(0,re.Z)(e,[{key:"sums",value:function(e){var t=e.copy;return M(this.sums_,t)}},{key:"detected",value:function(e){var t=e.copy;return M(this.detected_,t)}},{key:"subsetProportions",value:function(e,t){var r=t.copy;if(0!=e)throw"only 'index = 0' is supported for mimics";return M(this.proportion_,r)}},{key:"free",value:function(){}}]),e}(),de=function(){function e(t,r,n,a){(0,te.Z)(this,e),this.sums_=t,this.detected_=r,this.proportion_=n,this.discards=_.TS(a.length),this.discards.set(a)}return(0,re.Z)(e,[{key:"thresholdsSums",value:function(e){var t=e.copy;return M(this.sums_,t)}},{key:"thresholdsDetected",value:function(e){var t=e.copy;return M(this.detected_,t)}},{key:"thresholdsSubsetProportions",value:function(e,t){var r=t.copy;if(0!=e)throw"only 'index = 0' is supported for mimics";return M(this.proportion_,r)}},{key:"discardOverall",value:function(e){var t=e.copy;return M(this.discards,t)}},{key:"free",value:function(){this.discards.free()}}]),e}();function ve(e){var t=e.open("quality_control"),r=t.open("parameters");se={use_mito_default:r.open("use_mito_default",{load:!0}).values[0]>0,mito_prefix:r.open("mito_prefix",{load:!0}).values[0],nmads:r.open("nmads",{load:!0}).values[0]};var n=t.open("results"),a=n.open("metrics");ae.metrics=new me(a.open("sums",{load:!0}).values,a.open("detected",{load:!0}).values,a.open("proportion",{load:!0}).values);var s=n.open("thresholds"),o=s.open("sums",{load:!0}).values,u=s.open("detected",{load:!0}).values,i=s.open("proportion",{load:!0}).values,c=n.open("discards",{load:!0}).values;return ae.filters=new de(o,u,i,c),(0,w.Z)({},se)}function he(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.unsafe,r=void 0!==t&&t;return ae.metrics.sums({copy:!r})}function ye(){return ae.filters.discardOverall({copy:"view"})}function ge(){return"matrix"in ae||ue(),ae.matrix}var be={},_e=!1;function we(){var e=ge(),t=O(e.numberOfColumns(),"Float64Array",be),r=ye(),n=he({unsafe:!0}),a=t.array(),s=0;if(r.array().forEach((function(e,t){e||(a[s]=n[t],s++)})),s!=e.numberOfColumns())throw"normalization and filtering are not in sync";E(be.matrix),be.matrix=_.gk(e,{sizeFactors:t})}function Se(){_e=!1,oe&&(_e=!0),_e&&we()}function xe(){return{}}function ke(e){var t=e.createGroup("normalization");t.createGroup("parameters"),t.createGroup("results")}function Ge(e){}function De(){return"matrix"in be||we(),be.matrix}function Me(e){var t=De(),r=O(t.numberOfColumns(),"Float64Array",be);return t.row(e,{buffer:r}),r.slice()}var Ee={},Ne={},Oe=!1;function Te(e){if(Oe=!1,_e||e!=Ne.span){E(Ee.results);var t=De();Ee.results=_.rY(t,{span:e}),Ee.sorted_residuals=Ee.results.residuals().slice(),Ee.sorted_residuals.sort(),Ne.span=e,Oe=!0}}function Ae(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return e=D(e),{means:Ee.results.means({copy:e}),vars:Ee.results.variances({copy:e}),fitted:Ee.results.fitted({copy:e}),resids:Ee.results.residuals({copy:e})}}function Ue(){return Ae()}function Ze(e){var t=e.createGroup("feature_selection");t.createGroup("parameters").writeDataSet("span","Float64",[],Ne.span);for(var r=Ae(!1),n=t.createGroup("results"),a=0,s=["means","vars","fitted","resids"];a<s.length;a++){var o=s[a];n.writeDataSet(o,"Float64",null,r[o])}}var Re=function(){function e(t,r,n,a){(0,te.Z)(this,e),this.means_=t,this.vars_=r,this.fitted_=n,this.resids_=a}return(0,re.Z)(e,[{key:"means",value:function(e){var t=e.copy;return M(this.means_,t)}},{key:"variances",value:function(e){var t=e.copy;return M(this.vars_,t)}},{key:"fitted",value:function(e){var t=e.copy;return M(this.fitted_,t)}},{key:"residuals",value:function(e){var t=e.copy;return M(this.resids_,t)}},{key:"free",value:function(){}}]),e}();function je(e,t){var r=e.open("feature_selection"),n=r.open("parameters");Ne={span:n.open("span",{load:!0}).values[0]};for(var a=r.open("results"),s={},o=0,u=["means","vars","fitted","resids"];o<u.length;o++){var i=u[o],c=a.open(i,{load:!0}).values;t(c),s[i]=c}return Ee.results=new Re(s.means,s.vars,s.fitted,s.resids),Ee.sorted_residuals=Ee.results.residuals({copy:!0}),Ee.sorted_residuals.sort(),(0,w.Z)({},Ne)}function Ce(){return Ee.sorted_residuals}function ze(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.unsafe,r=void 0!==t&&t;return Ee.results.residuals({copy:!r})}var Fe={},Pe={},Ie=!1;function Be(e){var t=Ce(),r=t[t.length-e],n=O(t.length,"Uint8Array",Fe,"hvg_buffer"),a=ze({unsafe:!0});n.array().forEach((function(e,t,n){n[t]=a[t]>=r}))}function qe(e,t){if(Ie=!1,(Oe||e!==Pe.num_hvgs)&&(Be(e),Pe.num_hvgs=e,Ie=!0),Ie||_e||t!==Pe.num_pcs){"hvg_buffer"in Fe||Be(Pe.num_hvgs);var r=Fe.hvg_buffer,n=De();E(Fe.pcs),Fe.pcs=_.a9(n,{features:r,numberOfPCs:t}),Pe.num_pcs=t,Ie=!0}}function Ke(){var e=Fe.pcs,t=e.varianceExplained(),r=e.totalVariance();return t.forEach((function(e,n){t[n]=e/r})),{var_exp:t}}function We(e){var t=e.createGroup("pca"),r=t.createGroup("parameters");r.writeDataSet("num_hvgs","Int32",[],Pe.num_hvgs),r.writeDataSet("num_pcs","Int32",[],Pe.num_pcs);var n=t.createGroup("results"),a=Ke().var_exp;n.writeDataSet("var_exp","Float64",null,a);var s=Ye();n.writeDataSet("pcs","Float64",[s.num_obs,s.num_pcs],s.pcs)}var Le=function(){function e(t,r){(0,te.Z)(this,e),this.var_exp=r,this.pcs=_.RJ(t.length),this.pcs.set(t)}return(0,re.Z)(e,[{key:"principalComponents",value:function(e){var t=e.copy;return M(this.pcs,t)}},{key:"varianceExplained",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.copy,r=void 0===t||t;return M(this.var_exp,r)}},{key:"totalVariance",value:function(){return 1}},{key:"free",value:function(){this.pcs.free()}}]),e}();function Je(e){var t=e.open("pca"),r=t.open("parameters");Pe={num_hvgs:r.open("num_hvgs",{load:!0}).values[0],num_pcs:r.open("num_pcs",{load:!0}).values[0]};var n=t.open("results"),a=n.open("var_exp",{load:!0}).values,s=n.open("pcs",{load:!0}).values;return Fe.pcs=new Le(s,a),(0,w.Z)({},Pe)}function Ye(){var e=Fe.pcs.principalComponents({copy:"view"});return{pcs:e,num_pcs:Pe.num_pcs,num_obs:e.length/Pe.num_pcs}}var Ve={},He={},Xe=!1;function Qe(e){var t=Ye();Ve.raw=_.Fu(t.pcs,{approximate:e,numberOfDims:t.num_pcs,numberOfCells:t.num_obs})}function $e(e){Xe=!1,(Ie||e!=He.approximate)&&(Qe(e),He.approximate=e,Xe=!0)}function et(){return{}}function tt(e){var t=e.createGroup("neighbor_index");t.createGroup("parameters").writeDataSet("approximate","Uint8",[],Number(He.approximate)),t.createGroup("results")}function rt(e){var t=e.open("neighbor_index").open("parameters");return He={approximate:t.open("approximate",{load:!0}).value>0},(0,w.Z)({},He)}function nt(){return"raw"in Ve||Qe(He.approximate),Ve.raw}var at={},st={},ot=!1;function ut(){return"clusters"in at}function it(){if(ut())return at.clusters.membership({copy:"view"});throw"cannot fetch SNN clusters from an invalid state"}function ct(e,t,r,n){ot=!1;var a=Xe||t!==st.k,s=a||r!==st.scheme,o=s||n!==st.resolution;e&&!ut()&&(o=!0),"graph"in at||o&&(s=!0),"neighbors"in at||(s||o)&&(a=!0),a&&(E(at.neighbors),e?at.neighbors=_.wf(nt(),t):delete at.neighbors,st.k=t),s&&(E(at.graph),e?at.graph=_.bD(at.neighbors,{scheme:r}):delete at.graph,st.scheme=r),o&&(E(at.clusters),e?at.clusters=_.ZI(at.graph,{resolution:n}):delete at.clusters,st.resolution=n,ot=!0)}function lt(){return{}}function ft(e){var t=e.createGroup("snn_graph_cluster"),r=t.createGroup("parameters");r.writeDataSet("k","Int32",[],st.k),r.writeDataSet("scheme","Scheme",[],["rank","number","jaccard"][st.scheme]),r.writeDataSet("resolution","Float64",[],st.resolution);var n=t.createGroup("results");if(ut()){var a=it();n.writeDataSet("clusters","Int32",null,a)}}var pt=function(){function e(t){(0,te.Z)(this,e),this.buffer=_.Wf(t.length),this.buffer.set(t)}return(0,re.Z)(e,[{key:"membership",value:function(e){var t=e.copy;return M(this.buffer,t)}},{key:"free",value:function(){this.buffer.free()}}]),e}();function mt(e){var t=e.open("snn_graph_cluster"),r=t.open("parameters");(st={k:r.open("k",{load:!0}).values[0],scheme:r.open("scheme",{load:!0}).values[0],resolution:r.open("resolution",{load:!0}).values[0]}).scheme={rank:0,number:1,jaccard:2}[st.scheme];var n=t.open("results");if("clusters"in n.children){var a=n.open("clusters",{load:!0}).values;at.clusters=new pt(a)}return(0,w.Z)({},st)}var dt={},vt={},ht=!1;function yt(){return"raw"in dt}function gt(){if(yt())return dt.raw.clusters({copy:"view"});throw"cannot fetch k-means clusters from an invalid state"}function bt(e,t){ht=!1;var r=Ie||t!=vt.k;if(e&&!yt()&&(r=!0),r){if(E(dt.raw),e){var n=Ye();dt.raw=_.eu(n.pcs,t,{numberOfDims:n.num_pcs,numberOfCells:n.num_obs,initMethod:"pca-part"})}else delete dt.raw;vt.k=t,ht=!0}}function _t(){return{}}function wt(e){var t=e.createGroup("kmeans_cluster");t.createGroup("parameters").writeDataSet("k","Int32",[],vt.k);var r=t.createGroup("results");if(yt()){var n=gt();r.writeDataSet("clusters","Int32",null,n)}}var St=function(){function e(t){(0,te.Z)(this,e),this.buffer=_.Wf(t.length),this.buffer.set(t)}return(0,re.Z)(e,[{key:"clusters",value:function(e){var t=e.copy;return M(this.buffer,t)}},{key:"free",value:function(){this.buffer.free()}}]),e}();function xt(e){if(vt={k:10},"kmeans_cluster"in e.children){var t=e.open("kmeans_cluster"),r=t.open("parameters");vt.k=r.open("k",{load:!0}).values[0];var n=t.open("results");if("clusters"in n.children){var a=n.open("clusters",{load:!0}).values;dt.raw=new St(a)}}return(0,w.Z)({},vt)}var kt={},Gt=!1;function Dt(e){Gt=!0,e==kt.method&&("snn_graph"==e?ot||(Gt=!1):"kmeans"==e&&(ht||(Gt=!1))),kt.method=e}function Mt(){return{clusters:Ot().slice()}}function Et(e){var t=e.createGroup("choose_clustering");t.createGroup("parameters").writeDataSet("method","String",[],kt.method),t.createGroup("results")}function Nt(e){var t=e.open("choose_clustering").open("parameters");return kt={method:t.open("method",{load:!0}).values[0]},(0,w.Z)({},kt)}function Ot(){return"snn_graph"==kt.method?it():"kmeans"==kt.method?gt():void 0}function Tt(e){var t=nt(),r={num_obs:t.numberOfCells()},n=null,a=null,s=null,o=null;try{n=_.wf(t,e),a=_.Wf(n.numberOfCells()),s=_.Wf(n.size()),o=_.RJ(n.size()),n.serialize({runs:a,indices:s,distances:o}),r.size=n.size(),r.runs=a.array().slice(),r.indices=s.array().slice(),r.distances=o.array().slice()}finally{null!==n&&n.free(),null!==a&&a.free(),null!==s&&s.free(),null!==o&&o.free()}return r}function At(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],a=r.counter,s=new Promise((function(e,t){r.promises[a]={resolve:e,reject:t}}));return r.counter++,t.id=a,e.postMessage(t,n),s}function Ut(e,t){return e.onmessage=function(e){var r=e.data.type;if(r.endsWith("_iter"))postMessage({type:r,resp:{x:e.data.x,y:e.data.y,iteration:e.data.iteration}},[e.data.x.buffer,e.data.y.buffer]);else{var n=e.data.id,a=t.promises[n];"error"==r?a.reject(e.data.error):a.resolve(e.data.data),delete t.promises[n]}},At(e,{cmd:"INIT"},t)}function Zt(e,t,r,n){var a={cmd:"RUN",params:t},s=[];return null!==r&&(a.neighbors=r,T(r,s)),At(e,a,n,s)}var Rt={counter:0,promises:{}},jt={},Ct=null;function zt(){return Ut(Ct=new Worker(new URL(r.p+r.u(139),r.b),{type:void 0}),Rt)}var Ft=!1;function Pt(e,t,r,n){var a=null;n&&(a=Tt(_.Tk(e)));var s={perplexity:e,iterations:t,animate:r};Rt.run=Zt(Ct,s,a,Rt)}function It(e,t,r){var n=Xe||e!=jt.perplexity||"reloaded"in Rt;(Ft=n||t!=jt.iterations)&&(Pt(e,t,r,n),jt.perplexity=e,jt.iterations=t,jt.animate=r,delete Rt.reloaded)}function Bt(e){return qt.apply(this,arguments)}function qt(){return(qt=(0,y.Z)(b().mark((function e(t){var r;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!("reloaded"in Rt)){e.next=7;break}return G(r={x:Rt.reloaded.x,y:Rt.reloaded.y},t),r.iterations=jt.iterations,e.abrupt("return",r);case 7:return e.next=9,Rt.run;case 9:return e.abrupt("return",At(Ct,{cmd:"FETCH"},Rt));case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Kt(){return Bt(!0)}function Wt(e){return Lt.apply(this,arguments)}function Lt(){return(Lt=(0,y.Z)(b().mark((function e(t){var r,n,a,s;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.createGroup("tsne"),(n=r.createGroup("parameters")).writeDataSet("perplexity","Float64",[],jt.perplexity),n.writeDataSet("iterations","Int32",[],jt.iterations),n.writeDataSet("animate","Uint8",[],Number(jt.animate)),e.next=7,Bt(!1);case 7:return a=e.sent,(s=r.createGroup("results")).writeDataSet("x","Float64",null,a.x),s.writeDataSet("y","Float64",null,a.y),e.abrupt("return");case 12:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Jt(e){var t=e.open("tsne"),r=t.open("parameters");jt={perplexity:r.open("perplexity",{load:!0}).values[0],iterations:r.open("iterations",{load:!0}).values[0],animate:r.open("animate",{load:!0}).values[0]>0};var n=t.open("results");return Rt.reloaded={x:n.open("x",{load:!0}).values,y:n.open("y",{load:!0}).values},(0,w.Z)({},jt)}function Yt(){return"reloaded"in Rt?(Pt(jt.perplexity,jt.iterations,!0,!0),Rt.run.then((function(e){return{type:"tsne_rerun",data:{status:"SUCCESS"}}}))):At(Ct,{cmd:"RERUN"},Rt)}var Vt={counter:0,promises:{}},Ht={},Xt=null;function Qt(){Xt=new Worker(new URL(r.p+r.u(653),r.b),{type:void 0}),Vt.initialized=Ut(Xt,Vt)}var $t=!1;function er(e,t,r,n,a){var s=null;a&&(s=Tt(e));var o={num_neighbors:e,num_epochs:t,min_dist:r,animate:n};Vt.run=Zt(Xt,o,s,Vt)}function tr(e,t,r,n){var a=Xe||Ht.num_neighbors!=e||"reloaded"in Vt;($t=a||t!=Ht.num_epochs||r!=Ht.min_dist)&&(er(e,t,r,n,a),Ht.num_neighbors=e,Ht.num_epochs=t,Ht.min_dist=r,Ht.animate=n,delete Vt.reloaded)}function rr(e){return nr.apply(this,arguments)}function nr(){return(nr=(0,y.Z)(b().mark((function e(t){var r;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!("reloaded"in Vt)){e.next=7;break}return G(r={x:Vt.reloaded.x,y:Vt.reloaded.y},t),r.iterations=Ht.num_epochs,e.abrupt("return",r);case 7:return e.next=9,Vt.run;case 9:return e.abrupt("return",At(Xt,{cmd:"FETCH"},Vt));case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ar(){return rr(!0)}function sr(e){return or.apply(this,arguments)}function or(){return(or=(0,y.Z)(b().mark((function e(t){var r,n,a,s;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.createGroup("umap"),(n=r.createGroup("parameters")).writeDataSet("num_neighbors","Int32",[],Ht.num_neighbors),n.writeDataSet("num_epochs","Int32",[],Ht.num_epochs),n.writeDataSet("min_dist","Float64",[],Ht.min_dist),n.writeDataSet("animate","Uint8",[],Number(Ht.animate)),e.next=8,rr(!1);case 8:return a=e.sent,(s=r.createGroup("results")).writeDataSet("x","Float64",null,a.x),s.writeDataSet("y","Float64",null,a.y),e.abrupt("return");case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ur(e){var t=e.open("umap"),r=t.open("parameters");Ht={num_neighbors:r.open("num_neighbors",{load:!0}).values[0],num_epochs:r.open("num_epochs",{load:!0}).values[0],min_dist:r.open("min_dist",{load:!0}).values[0],animate:r.open("animate",{load:!0}).values[0]>0};var n=t.open("results");return Vt.reloaded={x:n.open("x",{load:!0}).values,y:n.open("y",{load:!0}).values},(0,w.Z)({},Ht)}function ir(){return"reloaded"in Vt?(er(Ht.num_neighbors,Ht.num_epochs,Ht.min_dist,!0,!0),Vt.run.then((function(e){return{type:"umap_rerun",data:{status:"SUCCESS"}}}))):At(Xt,{cmd:"RERUN"},Vt)}var cr={min:0,mean:1,min_rank:4},lr={0:"min",1:"mean",4:"min_rank"};function fr(e,t,r){for(var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=n.no_summaries,s=void 0!==a&&a,o=e.createGroup(String(r)),u=0,i=["means","detected"];u<i.length;u++){var c=i[u],l=t[c](r,{copy:"view"});o.writeDataSet(c,"Float64",null,l)}for(var f=function(){var e=m[p],n=e;"delta_detected"==e&&(n="deltaDetected");var a=function(e){return t[n](r,{summary:e,copy:"view"})};if(s){var u=a(cr.mean);o.writeDataSet(e,"Float64",null,u)}else for(var i=o.createGroup(e),c=0,l=Object.entries(cr);c<l.length;c++){var f=(0,S.Z)(l[c],2),d=f[0],v=a(f[1]);i.writeDataSet(d,"Float64",null,v)}},p=0,m=["lfc","delta_detected","auc","cohen"];p<m.length;p++)f()}function pr(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=r.no_summaries,a=void 0!==n&&n,s={},o=0,u=["means","detected"];o<u.length;o++){var i=u[o];s[i]=e.open(i,{load:!0}).values,t(s[i])}for(var c=0,l=["lfc","delta_detected","auc","cohen"];c<l.length;c++){var f=l[c];if(a)s[f]=e.open(f,{load:!0}).values;else{for(var p=e.open(f),m={},d=0,v=Object.keys(cr);d<v.length;d++){var h=v[d];m[h]=p.open(h,{load:!0}).values,t(m[h])}s[f]=m}}return s}function mr(e,t,r){var n;t&&void 0!==t||(t="cohen-min-rank");var a,s=!1,o=1;if(t.match(/-min$/)?o=0:t.match(/-min-rank$/)&&(s=!0,o=4),t.match(/^cohen-/))a=e.cohen(r,{summary:o,copy:!1});else if(t.match(/^auc-/))a=e.auc(r,{summary:o,copy:!1});else if(t.match(/^lfc-/))a=e.lfc(r,{summary:o,copy:!1});else{if(!t.match(/^delta-d-/))throw"unknown rank type '"+t+"'";a=e.deltaDetected(r,{summary:o,copy:!1})}n=new Int32Array(a.length);for(var u=0;u<n.length;u++)n[u]=u;s?n.sort((function(e,t){return a[e]-a[t]})):n.sort((function(e,t){return a[t]-a[e]}));var i=function(e){for(var t=new Float64Array(e.length),r=0;r<n.length;r++)t[r]=e[n[r]];return t},c=i(e.detected(r,{copy:!1})),l=i(e.means(r,{copy:!1})),f=i(e.lfc(r,{summary:1,copy:!1})),p=i(e.deltaDetected(r,{summary:1,copy:!1}));return{ordering:n,means:l,detected:c,lfc:f,delta_detected:p}}var dr={},vr=!1;function hr(){if(vr=!1,_e||Gt){var e=De(),t=Ot();E(dr.raw),dr.raw=_.y5(e,t),vr=!0}}function yr(){return{}}function gr(e){var t=e.createGroup("marker_detection");t.createGroup("parameters");for(var r=t.createGroup("results").createGroup("clusters"),n=dr.raw.numberOfGroups(),a=0;a<n;a++)fr(r,dr.raw,a)}var br,_r=function(){function e(t){(0,te.Z)(this,e),this.clusters=t}return(0,re.Z)(e,[{key:"effect_grabber",value:function(e,t,r,n){var a=lr[r];return M(this.clusters[t][e][a],n)}},{key:"lfc",value:function(e,t){var r=t.summary,n=t.copy;return this.effect_grabber("lfc",e,r,n)}},{key:"deltaDetected",value:function(e,t){var r=t.summary,n=t.copy;return this.effect_grabber("delta_detected",e,r,n)}},{key:"cohen",value:function(e,t){var r=t.summary,n=t.copy;return this.effect_grabber("cohen",e,r,n)}},{key:"auc",value:function(e,t){var r=t.summary,n=t.copy;return this.effect_grabber("auc",e,r,n)}},{key:"stat_grabber",value:function(e,t,r){return M(this.clusters[t][e],r)}},{key:"means",value:function(e,t){var r=t.copy;return this.stat_grabber("means",e,r)}},{key:"detected",value:function(e,t){var r=t.copy;return this.stat_grabber("detected",e,r)}},{key:"numberOfGroups",value:function(){return Object.keys(this.clusters).length}},{key:"free",value:function(){}}]),e}();function wr(e,t){for(var r=e.open("marker_detection").open("results").open("clusters"),n={},a=0,s=Object.keys(r.children);a<s.length;a++){var o=s[a];n[Number(o)]=pr(r.open(o),t)}dr.raw=new _r(n)}function Sr(e,t){return mr(dr.raw,e,t)}function xr(){return dr.raw.numberOfGroups()}function kr(e,t){var r=t.copy,n=void 0===r||r;return dr.raw.means(e,{copy:n})}var Gr=null;function Dr(){return null===Gr&&(Gr=new Promise((function(e,t){(br=indexedDB.open("DownloadsDB",3)).onupgradeneeded=function(e){var t=e.target.result;try{t.deleteObjectStore("downloads")}catch(e){}t.createObjectStore("downloads",{keyPath:"url"})},br.onsuccess=function(){e(null)},br.onerror=function(){t("failed to initialize DownloadsDB")}}))),Gr}function Mr(e){return Er.apply(this,arguments)}function Er(){return Er=(0,y.Z)(b().mark((function e(t){var r,n,a,s,o,u,i,c,l,f,p,m,d=arguments;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=d.length>1&&void 0!==d[1]?d[1]:null,n=d.length>2&&void 0!==d[2]&&d[2],e.next=4,Gr;case 4:if(n){e.next=13;break}return a=br.result.transaction(["downloads"],"readonly"),s=a.objectStore("downloads"),o=new Promise((function(e){var r=s.get(t);r.onsuccess=function(t){void 0!==r.result?e(r.result.payload):e(null)},r.onerror=function(t){e(null)}})),e.next=10,o;case 10:if(null===(u=e.sent)){e.next=13;break}return e.abrupt("return",u);case 13:return i=null==r?fetch(t):fetch(t,r),e.next=16,i;case 16:if((c=e.sent).ok){e.next=19;break}throw"failed to download '"+t+"' ("+c.status+")";case 19:return e.next=21,c.arrayBuffer();case 21:return l=e.sent,f=br.result.transaction(["downloads"],"readwrite"),p=f.objectStore("downloads"),m=new Promise((function(e){var r=p.put({url:t,payload:l});r.onsuccess=function(t){e(!0)},r.onerror=function(t){e(!1)}})),e.next=27,m;case 27:if(e.sent){e.next=30;break}throw"failed to download resources for '"+t+"'";case 30:return e.abrupt("return",l);case 31:case"end":return e.stop()}}),e)}))),Er.apply(this,arguments)}var Nr={},Or={},Tr=!1,Ar={},Ur={},Zr={},Rr={},jr="https://cors-proxy.aaron-lun.workers.dev",Cr="https://github.com/clusterfork/singlepp-references/releases/download/hs-latest",zr="https://github.com/clusterfork/singlepp-references/releases/download/mm-latest";function Fr(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"gz",r=e;"gz"==t&&(r=Z.ec(e));var n=new TextDecoder,a=n.decode(r),s=a.split("\n");return s.length>0&&""==s[s.length-1]&&s.pop(),s}function Pr(e,t,r){return Ir.apply(this,arguments)}function Ir(){return Ir=(0,y.Z)(b().mark((function e(t,r,n){var a,s,o,u,i,c,l,f,p,m,d,v,h;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("human"==r?(a=Cr,o=Ar,s=Zr):(a=zr,o=Ur,s=Rr),Dr(),t in o){e.next=20;break}return e.next=5,Promise.all([Mr(jr+"/"+encodeURIComponent(a+"/"+t+"_genes.csv.gz")),Mr(jr+"/"+encodeURIComponent(a+"/"+t+"_labels_fine.csv.gz")),Mr(jr+"/"+encodeURIComponent(a+"/"+t+"_label_names_fine.csv.gz")),Mr(jr+"/"+encodeURIComponent(a+"/"+t+"_markers_fine.gmt.gz")),Mr(jr+"/"+encodeURIComponent(a+"/"+t+"_matrix.csv.gz"))]);case 5:u=e.sent,e.prev=6,i=_.tY(new Uint8Array(u[4]),new Uint8Array(u[3]),new Uint8Array(u[1])),c=Fr(new Uint8Array(u[0])),l=[],f=[],c.forEach((function(e){var t=e.split(",");l.push(t[0]),f.push(t[1])})),p=Fr(new Uint8Array(u[2])),o[t]={raw:i,genes:{ensembl:l,symbol:f},labels:p},e.next=20;break;case 16:throw e.prev=16,e.t0=e.catch(6),E(i),e.t0;case 20:if(t in s&&!n){e.next=34;break}e.prev=21,t in s&&E(s[t].raw),m=o[t],d=m.raw,v="ensembl"===Nr.feature_details.type?m.genes.ensembl:m.genes.symbol,h=_.St(Nr.features,d,v),s[t]={features:v,raw:h},e.next=34;break;case 30:throw e.prev=30,e.t1=e.catch(21),E(undefined),e.t1;case 34:return e.abrupt("return",{loaded:o[t],built:s[t]});case 35:case"end":return e.stop()}}),e,null,[[6,16],[21,30]])}))),Ir.apply(this,arguments)}function Br(e,t){if("undefined"===typeof e||"undefined"===typeof t)return!1;if(e.length!=t.length)return!1;for(var r=0;r<e.length;r++)if(e[r]!=t[r])return!1;return!0}function qr(e,t){Tr=!1;var r=!1;!z&&"feature_space"in Nr||(r=!0,Tr=!0,function(){for(var e=Q(),t=$(),r=null,n=null,a=0,s=Object.entries(t);a<s.length;a++){var o=(0,S.Z)(s[a],2),u=o[0],i=o[1];(null===n||i.confidence>n.confidence)&&(r=u,n=i)}Nr.features=e[r],Nr.feature_details=n}());var n,a=Nr.feature_details.species,s=(Dr(),{});if("human"==a){var o,u=(0,x.Z)(e);try{for(u.s();!(o=u.n()).done;){var i=o.value;s[i]=Pr(i,"human",r)}}catch(p){u.e(p)}finally{u.f()}}else if("mouse"==a){var c,l=(0,x.Z)(t);try{for(l.s();!(c=l.n()).done;){var f=c.value;s[f]=Pr(f,"mouse",r)}}catch(p){l.e(p)}finally{l.f()}}(Br(e,Or.human_references)&&Br(t,Or.mouse_references)||(Or.human_references=e,Or.mouse_references=t,Tr=!0),Tr)&&function(){var e=Nr.features.length,t=xr(),a=O(t*e,"Float64Array",Nr);for(n=0;n<t;n++){var o=kr(n,{copy:!1});a.array().set(o,n*e)}Nr.results={};for(var u=0,i=Object.entries(s);u<i.length;u++){var c=(0,S.Z)(i[u],2),l=c[0],f=c[1];Nr.results[l]=f.then((function(r){var n,s=_.pG(a,r.built.raw,{numberOfFeatures:e,numberOfCells:t}),o=[],u=(0,x.Z)(s);try{for(u.s();!(n=u.n()).done;){var i=n.value;o.push(r.loaded.labels[i])}}catch(p){u.e(p)}finally{u.f()}return o}))}var m=Object.keys(s);if(m.length>1){if(r||!Br(m,Nr.used)){var d=Object.values(s);Nr.integrated=Promise.all(d).then((function(e){var t=e.map((function(e){return e.loaded.raw})),r=e.map((function(e){return e.built.features})),n=e.map((function(e){return e.built.raw}));return _.Qj(Nr.features,t,r,n)}))}Nr.integrated_results=Nr.integrated.then(function(){var r=(0,y.Z)(b().mark((function r(n){var s,o,u,i,c,l;return b().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:s=[],o=(0,x.Z)(m),r.prev=2,o.s();case 4:if((u=o.n()).done){r.next=13;break}return i=u.value,r.t0=s,r.next=9,Nr.results[i];case 9:r.t1=r.sent,r.t0.push.call(r.t0,r.t1);case 11:r.next=4;break;case 13:r.next=18;break;case 15:r.prev=15,r.t2=r.catch(2),o.e(r.t2);case 18:return r.prev=18,o.f(),r.finish(18);case 21:return c=_.Os(a,s,n,{numberOfFeatures:e,numberOfCells:t}),l=[],c.forEach((function(e){l.push(m[e])})),r.abrupt("return",l);case 25:case"end":return r.stop()}}),r,null,[[2,15,18,21]])})));return function(e){return r.apply(this,arguments)}}())}else delete Nr.integrated_results;Nr.used=m,Tr=!0}()}function Kr(){return Wr.apply(this,arguments)}function Wr(){return(Wr=(0,y.Z)(b().mark((function e(){var t,r,n,a,s,o,u;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t={},r=0,n=Object.entries(Nr.results);case 2:if(!(r<n.length)){e.next=10;break}return a=(0,S.Z)(n[r],2),s=a[0],o=a[1],e.next=6,o;case 6:t[s]=e.sent;case 7:r++,e.next=2;break;case 10:if(u={per_reference:t},!("integrated_results"in Nr)){e.next=15;break}return e.next=14,Nr.integrated_results;case 14:u.integrated=e.sent;case 15:return e.abrupt("return",u);case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Lr(e){return Jr.apply(this,arguments)}function Jr(){return(Jr=(0,y.Z)(b().mark((function e(t){var r,n,a,s,o,u,i,c,l,f;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.createGroup("cell_labelling"),(n=r.createGroup("parameters")).writeDataSet("mouse_references","String",null,Or.mouse_references),n.writeDataSet("human_references","String",null,Or.human_references),a=r.createGroup("results"),e.next=7,Kr();case 7:for(s=e.sent,o=a.createGroup("per_reference"),u=0,i=Object.entries(s.per_reference);u<i.length;u++)c=(0,S.Z)(i[u],2),l=c[0],f=c[1],o.writeDataSet(l,"String",null,f);return"integrated"in s&&a.writeDataSet("integrated","String",null,s.integrated),e.abrupt("return");case 12:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Yr(e){if(Or={mouse_references:[],human_references:[]},Nr.results={},"cell_labelling"in e.children){var t=e.open("cell_labelling"),r=t.open("parameters");Or.mouse_references=r.open("mouse_references",{load:!0}).values,Or.human_references=r.open("human_references",{load:!0}).values;for(var n=t.open("results"),a=n.open("per_reference"),s=0,o=Object.keys(a.children);s<o.length;s++){var u=o[s];Nr.results[u]=a.open(u,{load:!0}).values}"integrated"in n.children&&(Nr.integrated_results=n.open("integrated",{load:!0}).values)}return(0,w.Z)({},Or)}var Vr={results:{}},Hr={selections:{}},Xr=!1;function Qr(e){if(oe){Hr.selections={};for(var t=0,r=Object.entries(Vr.results);t<r.length;t++){var n=(0,S.Z)(r[t],2);n[0];E(n[1].raw)}Vr.results={}}Xr=!0}function $r(){return{}}function en(e){for(var t=e.createGroup("custom_selections"),r=t.createGroup("parameters").createGroup("selections"),n=0,a=Object.entries(Hr.selections);n<a.length;n++){var s=(0,S.Z)(a[n],2),o=s[0],u=s[1];r.writeDataSet(String(o),"Uint8",null,u)}for(var i=t.createGroup("results").createGroup("markers"),c=0,l=Object.entries(Vr.results);c<l.length;c++){var f=(0,S.Z)(l[c],2);f[0];fr(i,f[1],1,{no_summaries:!0})}}var tn,rn=function(){function e(t){(0,te.Z)(this,e),this.results=t}return(0,re.Z)(e,[{key:"effect_grabber",value:function(e,t,r,n){if(1!=t)throw"only group 1 is supported for custom marker mimics";if(1!=r)throw"only the mean effect size is supported for custom marker mimics";return M(this.results[t][e],n)}},{key:"lfc",value:function(e,t){var r=t.summary,n=t.copy;return effect_grabber("lfc",e,r,n)}},{key:"deltaDetected",value:function(e,t){var r=t.summary,n=t.copy;return effect_grabber("delta_detected",e,r,n)}},{key:"cohen",value:function(e,t){var r=t.summary,n=t.copy;return effect_grabber("cohen",e,r,n)}},{key:"auc",value:function(e,t){var r=t.summary,n=t.copy;return effect_grabber("auc",e,r,n)}},{key:"stat_grabber",value:function(e,t,r){return M(this.results[t][e],r)}},{key:"means",value:function(e,t){var r=t.copy;return stat_grabber("means",e,r)}},{key:"detected",value:function(e,t){var r=t.copy;return stat_grabber("detected",e,r)}},{key:"free",value:function(){}}]),e}();function nn(e,t){var r=e.open("custom_selections"),n=r.open("parameters").open("selections");Hr={selections:{}};for(var a=0,s=Object.keys(n.children);a<s.length;a++){var o=s[a];Hr.selections[o]=n.open(o,{load:!0}).values}var u=r.open("results").open("markers");Vr.results={};for(var i=0,c=Object.keys(u.children);i<c.length;i++){var l=c[i],f=pr(u.open(l),t,{no_summaries:!0});Vr.results[l]=new rn(f)}for(var p={selections:{}},m=0,d=Object.entries(Hr.selections);m<d.length;m++){var v=(0,S.Z)(d[m],2),h=v[0],y=v[1];p.selections[h]=y.slice()}return p}function an(e,t){var r=De(),n=O(r.numberOfColumns(),"Int32Array",Vr);n.fill(0);var a=n.array();t.forEach((function(e){a[e]=1}));var s=_.y5(r,n);e in Vr.results&&(E(Vr.results[e].raw),delete Vr.results[e]),Vr.results[e]={raw:s},Hr.selections[e]=t}function sn(e){E(Vr.results[e].raw),delete Vr.results[e],delete Hr.selections[e]}function on(e,t){return mr(Vr.results[e].raw,t,1)}var un=null;function cn(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;null===t&&(t=tn.result.transaction(["analysis_meta"],"readonly").objectStore("analysis_meta"));var r=t.getAll();r.onsuccess=function(){var t=r.result;t.forEach((function(e){delete e.files})),e(t)},r.onerror=function(){e(null)}}function ln(e,t){return fn.apply(this,arguments)}function fn(){return(fn=(0,y.Z)(b().mark((function e(t,r){return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e){var n=r.get(t);n.onsuccess=function(){void 0!==n.result?e(n.result):e(null)},n.onerror=function(){e(null)}})));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function pn(e){return Promise.allSettled(e).then((function(e){var t,r=(0,x.Z)(e);try{for(r.s();!(t=r.n()).done;){if(!t.value)return!1}}catch(n){r.e(n)}finally{r.f()}return!0}))}function mn(){return dn.apply(this,arguments)}function dn(){return(dn=(0,y.Z)(b().mark((function e(){return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,un;case 2:return e.abrupt("return",new Promise((function(e){cn(e)})));case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function vn(e,t){return hn.apply(this,arguments)}function hn(){return(hn=(0,y.Z)(b().mark((function e(t,r){var n,a,s,o,u,i,c;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,un;case 2:return n=tn.result.transaction(["file","file_meta"],"readwrite"),a=n.objectStore("file"),s=n.objectStore("file_meta"),e.next=7,ln(t,s);case 7:return o=e.sent,u=null===o?0:o.count,u++,i=new Promise((function(e){var n=a.put({id:t,payload:r});n.onsuccess=function(t){e(!0)},n.onerror=function(t){e(!1)}})),c=new Promise((function(e){o.count=u;var t=s.put(o);t.onsuccess=function(t){e(!0)},t.onerror=function(t){e(!1)}})),e.abrupt("return",pn([i,c]));case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function yn(e,t,r,n){return gn.apply(this,arguments)}function gn(){return(gn=(0,y.Z)(b().mark((function e(t,r,n,a){var s,o,u,i,c,l;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,un;case 2:if(s=tn.result.transaction(["analysis","analysis_meta"],"readwrite"),o=s.objectStore("analysis"),u=s.objectStore("analysis_meta"),null!=t){e.next=10;break}return e.next=8,new Promise((function(e){return cn(e,u)}));case 8:i=e.sent,t=String(i.length);case 10:return c=new Promise((function(e){var n=o.put({id:t,payload:r});n.onsuccess=function(t){e(!0)},n.onerror=function(t){e(!1)}})),l=new Promise((function(e){var r=u.put({id:t,files:n,time:Number(new Date),title:a});r.onsuccess=function(t){e(!0)},r.onerror=function(t){e(!1)}})),e.next=14,pn([c,l]);case 14:if(!e.sent){e.next=18;break}return e.abrupt("return",t);case 18:return e.abrupt("return",null);case 19:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function bn(e){return _n.apply(this,arguments)}function _n(){return(_n=(0,y.Z)(b().mark((function e(t){var r,n;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,un;case 2:return r=tn.result.transaction(["file"],"readonly").objectStore("file"),e.next=5,ln(t,r);case 5:return n=e.sent,e.abrupt("return",n.payload);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function wn(){return(wn=(0,y.Z)(b().mark((function e(t){var r,n;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,un;case 2:return r=tn.result.transaction(["analysis"],"readonly").objectStore("analysis"),e.next=5,ln(t,r);case 5:return n=e.sent,e.abrupt("return",n.payload);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Sn(e){return xn.apply(this,arguments)}function xn(){return(xn=(0,y.Z)(b().mark((function e(t){var r,n,a,s,o,u;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,un;case 2:return r=tn.result.transaction(["file","file_meta"],"readwrite"),n=r.objectStore("file"),a=r.objectStore("file_meta"),e.next=7,ln(t,a);case 7:return s=e.sent,o=s.count,o--,u=[],0==o?(u.push(new Promise((function(e){var r=n.remove(t);r.onerror=function(t){e(!1)},r.onsuccess=function(t){e(!0)}}))),u.push(new Promise((function(e){var r=a.delete(t);r.onerror=function(t){e(!1)},r.onsuccess=function(t){e(!0)}})))):u.push(new Promise((function(e){s.count=o;var t=a.put(s);t.onsuccess=function(t){e(!0)},t.onerror=function(t){e(!1)}}))),e.abrupt("return",pn(u));case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function kn(){return(kn=(0,y.Z)(b().mark((function e(t){var r,n,a,s,o,u,i,c;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,un;case 2:return r=tn.result.transaction(["analysis","analysis_meta"],"readwrite"),n=r.objectStore("analysis"),a=r.objectStore("analysis_meta"),(s=[]).push(new Promise((function(e){var r=n.delete(t);r.onsuccess=function(t){e(!0)},r.onerror=function(t){e(!1)}}))),e.next=9,ln(t,a);case 9:o=e.sent,u=(0,x.Z)(o.files);try{for(u.s();!(i=u.n()).done;)c=i.value,s.push(Sn(c))}catch(l){u.e(l)}finally{u.f()}return s.push(new Promise((function(e){var r=a.delete(t);r.onsuccess=function(t){e(!0)},r.onerror=function(t){e(!1)}}))),e.abrupt("return",pn(s));case 14:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var Gn=r(8109);function Dn(e){if(Array.isArray(e))for(var t=0;t<e.length;t++)e[t]=Dn(e[t]);else if(e instanceof Object)if("_TypedArray_class"in e){var r=e[["_TypedArray_class"]],n=e[["_TypedArray_values"]];switch(r){case"Uint8Array":case"Uint8Array":e=new Uint8Array(n.length);break;case"Int8Array":e=new Int8Array(n.length);break;case"Uint16Array":e=new Uint16Array(n.length);break;case"Int16Array":e=new Int16Array(n.length);break;case"Uint32Array":e=new Uint32Array(n.length);break;case"Int32Array":e=new Int32Array(n.length);break;case"Uint64Array":e=new Uint64Array(n.length);break;case"Int64Array":e=new Int64Array(n.length);break;case"Float32Array":e=new Float32Array(n.length);break;case"Float64Array":e=new Float64Array(n.length);break;default:throw"unrecognized TypedArray class '"+r}e.set(n)}else for(var a=0,s=Object.entries(e);a<s.length;a++){var o=(0,S.Z)(s[a],2),u=o[0],i=o[1];e[u]=Dn(i)}return e}function Mn(e,t){var r=_.ll(t),n=r.createGroup("inputs"),a=e.inputs.parameters,s=n.createGroup("parameters");s.writeDataSet("format","String",[],a.type);var o,u=s.createGroup("files"),i=(0,x.Z)(a.files.entries());try{for(i.s();!(o=i.n()).done;){var c=(0,S.Z)(o.value,2),l=c[0],f=c[1],p=u.createGroup(String(l));p.writeDataSet("type","String",[],f.type),p.writeDataSet("name","String",[],f.name),f.buffer instanceof Object?(p.writeDataSet("offset","Uint32",[],f.buffer.offset),p.writeDataSet("size","Uint32",[],f.buffer.size)):p.writeDataSet("id","String",[],f.buffer)}}catch(yt){i.e(yt)}finally{i.f()}var m=n.createGroup("results"),d=e.inputs.contents,v=Object.values(d.genes)[0].length;m.writeDataSet("dimensions","Int32",null,[v,d.num_cells]);for(var h=m.createGroup("genes"),y=0,g=Object.entries(d.genes);y<g.length;y++){var b=(0,S.Z)(g[y],2),w=b[0],k=b[1];h.writeDataSet(w,"String",null,k)}var G=r.createGroup("quality_control"),D=G.createGroup("parameters"),M=e.quality_control_metrics.parameters;D.writeDataSet("use_mito_default","Uint8",[],Number(M.use_mito_default)),D.writeDataSet("mito_prefix","String",[],M.mito_prefix);var E=e.quality_control_thresholds.parameters;D.writeDataSet("nmads","Float64",[],E.nmads);var N=G.createGroup("results"),O=N.createGroup("metrics"),T=Dn(e.quality_control_metrics.contents);O.writeDataSet("sums","Float64",null,T.sums),O.writeDataSet("detected","Int32",null,T.detected),O.writeDataSet("proportion","Float64",null,T.proportion);for(var A=N.createGroup("thresholds"),U=Dn(e.quality_control_thresholds.contents),Z=0,R=["sums","detected","proportion"];Z<R.length;Z++){var j=R[Z];A.writeDataSet(j,"Float64",null,[U[j]])}var C=U.discards;N.writeDataSet("discards","Uint8",null,C);var z=r.createGroup("normalization");z.createGroup("parameters"),z.createGroup("results");var F=r.createGroup("feature_selection");F.createGroup("parameters").writeDataSet("span","Float64",[],e.feature_selection.parameters.span);for(var P=F.createGroup("results"),I=Dn(e.feature_selection.contents),B=0,q=["means","vars","fitted","resids"];B<q.length;B++){var K=q[B];P.writeDataSet(K,"Float64",null,I[K])}for(var W=r.createGroup("pca"),L=W.createGroup("parameters"),J=e.pca.parameters,Y=0,V=["num_hvgs","num_pcs"];Y<V.length;Y++){var H=V[Y];L.writeDataSet(H,"Int32",null,J[H])}var X=W.createGroup("results"),Q=Dn(e.pca.contents),$=Q.var_exp;X.writeDataSet("var_exp","Float64",null,$);var ee=$.length,te=Q.pcs.length/ee;X.writeDataSet("pcs","Float64",[te,ee],Q.pcs);var re=r.createGroup("neighbor_index"),ne=re.createGroup("parameters"),ae=e.pca.parameters;ne.writeDataSet("approximate","Uint8",[],Number(ae.approximate)),re.createGroup("results");var se=r.createGroup("tsne"),oe=se.createGroup("parameters"),ue=e.tsne.parameters;oe.writeDataSet("perplexity","Float64",[],ue.perplexity),oe.writeDataSet("iterations","Int32",[],ue.iterations),oe.writeDataSet("animate","Uint8",[],ue.animate);var ie=se.createGroup("results"),ce=Dn(e.tsne.contents);ie.writeDataSet("x","Float64",null,ce.x),ie.writeDataSet("y","Float64",null,ce.y);var le=r.createGroup("umap"),fe=le.createGroup("parameters"),pe=e.umap.parameters;fe.writeDataSet("num_neighbors","Int32",[],pe.num_neighbors),fe.writeDataSet("num_epochs","Int32",[],pe.num_epochs),fe.writeDataSet("min_dist","Float64",[],pe.min_dist),fe.writeDataSet("animate","Uint8",[],Number(pe.animate));var me=le.createGroup("results"),de=Dn(e.umap.contents);me.writeDataSet("x","Float64",null,de.x),me.writeDataSet("y","Float64",null,de.y);var ve=r.createGroup("kmeans_cluster"),he=ve.createGroup("parameters").createDataSet("k","Int32",[]);if("kmeans_cluster"in e){var ye=e.kmeans_cluster.parameters;he.write(ye.k)}else he.write(10);var ge=ve.createGroup("results"),be=Dn(e.kmeans_cluster.contents);"kmeans_cluster"in e&&ge.writeDataSet("clusters","Int32",null,be.clusters);var _e=r.createGroup("snn_graph_cluster"),we=_e.createGroup("parameters"),Se=e.snn_find_neighbors.parameters;we.writeDataSet("k","Int32",[],Se.k);var xe=e.snn_build_graph.parameters;we.writeDataSet("scheme","String",[],["rank","number","jaccard"][xe.scheme]);var ke=e.snn_cluster_graph.parameters;we.writeDataSet("resolution","Float64",[],ke.resolution);var Ge=_e.createGroup("results"),De=Dn(e.snn_cluster_graph.contents);Ge.writeDataSet("clusters","Int32",null,De.clusters),r.createGroup("choose_clustering").createGroup("parameters").writeDataSet("method","String",[],e.choose_clustering.parameters.method);var Me=r.createGroup("marker_detection");Me.createGroup("parameters");var Ee,Ne=Me.createGroup("results").createGroup("clusters"),Oe=e.marker_detection.contents,Te=(0,x.Z)(Oe.entries());try{for(Te.s();!(Ee=Te.n()).done;){for(var Ae=(0,S.Z)(Ee.value,2),Ue=Ae[0],Ze=Ae[1],Re=Ne.createGroup(String(Ue)),je=Dn(Ze),Ce=0,ze=["means","detected"];Ce<ze.length;Ce++){var Fe=ze[Ce];Re.writeDataSet(Fe,"Float64",null,je[Fe])}for(var Pe=0,Ie=["lfc","delta_detected","auc","cohen"];Pe<Ie.length;Pe++)for(var Be=Ie[Pe],qe=je[Be],Ke=Re.createGroup(Be),We=0,Le=["min","mean","min-rank"];We<Le.length;We++){var Je=Le[We],Ye="min-rank"==Je?"min_rank":Je;Ke.writeDataSet(Ye,"Float64",null,qe[Je])}}}catch(yt){Te.e(yt)}finally{Te.f()}for(var Ve=r.createGroup("custom_selections"),He=Ve.createGroup("parameters").createGroup("selections"),Xe=e.custom_marker_management.parameters,Qe=0,$e=Object.entries(Xe.selections);Qe<$e.length;Qe++){var et=(0,S.Z)($e[Qe],2),tt=et[0],rt=et[1];He.writeDataSet(String(tt),"Int32",null,rt)}for(var nt=Ve.createGroup("results").createGroup("markers"),at=0,st=Object.entries(e.custom_marker_management.contents.results);at<st.length;at++){for(var ot=(0,S.Z)(st[at],2),ut=ot[0],it=ot[1],ct=nt.createGroup(String(ut)),lt=Dn(it),ft=0,pt=["means","detected"];ft<pt.length;ft++){var mt=pt[ft];ct.writeDataSet(mt,"Float64",null,lt[mt])}for(var dt=0,vt=["lfc","delta_detected","auc","cohen"];dt<vt.length;dt++){var ht=vt[dt];ct.writeDataSet(ht,"Float64",null,lt[ht].mean)}}}function En(e){for(var t=new Uint8Array(8),r=0;e>0;)t[r]=e%256,e=Math.floor(e/256),r++;return t}function Nn(e){var t,r=0,n=1,a=(0,x.Z)(e);try{for(a.s();!(t=a.n()).done;){r+=n*t.value,n*=256}}catch(s){a.e(s)}finally{a.f()}return r}function On(e){var t={collected:[]};return e?(t.sofar=0,t.saver=function(e){t.collected.push(e.buffer);var r=t.sofar,n=e.buffer.byteLength;return t.sofar+=n,{offset:r,size:n}}):t.saver=function(){var e=(0,y.Z)(b().mark((function e(r){var n,a;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Gn.FB(new Uint8Array(r.buffer));case 2:return n=e.sent,a=r.type+"_"+r.name+"_"+r.buffer.byteLength+"_"+n,e.next=6,vn(a,r.buffer);case 6:if(e.sent){e.next=9;break}throw"failed to save file '"+a+"' to KanaDB";case 9:return t.collected.push(a),e.abrupt("return",a);case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),t}function Tn(e,t,r){var n=new ArrayBuffer(24+t.length+r),a=new Uint8Array(n),s=0,o=En(e);a.set(o,s),s+=o.length;var u=En(1e6);a.set(u,s),s+=u.length;var i=En(t.length);if(a.set(i,s),24!=(s+=i.length))throw"oops - accounting error in the serialization code!";return a.set(t,s),{offset:s+=t.length,combined:n}}function An(e,t){var r,n=0,a=(0,x.Z)(t);try{for(a.s();!(r=a.n()).done;){n+=r.value.byteLength}}catch(p){a.e(p)}finally{a.f()}var s,o=Tn(0,e,n),u=o.offset,i=new Uint8Array(o.combined),c=(0,x.Z)(t);try{for(c.s();!(s=c.n()).done;){var l=s.value,f=new Uint8Array(l);i.set(f,u),u+=f.length}}catch(p){c.e(p)}finally{c.f()}return o.combined}function Un(e,t,r){return Zn.apply(this,arguments)}function Zn(){return(Zn=(0,y.Z)(b().mark((function e(t,r,n){var a,s;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=Tn(1,t,0),e.next=3,yn(null,a.combined,r,n);case 3:return s=e.sent,e.abrupt("return",s);case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Rn(e,t){return jn.apply(this,arguments)}function jn(){return(jn=(0,y.Z)(b().mark((function e(t,r){var n,a,s,o,u,i,c;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=0,a=Nn(new Uint8Array(t,n,8)),n+=8,s=Nn(new Uint8Array(t,n,8)),n+=8,o=Nn(new Uint8Array(t,n,8)),n+=8,u=new Uint8Array(t,n,o),n+=o,s<1e6?(i=Z.ec(u,{to:"string"}),Mn(JSON.parse(i),r)):_.NC(r,u),c={},0!=a){e.next=17;break}c.remaining=new Uint8Array(t,n,t.byteLength-n),c.loader=function(e,t){return c.remaining.slice(e,e+t)},c.embedded=!0,e.next=23;break;case 17:if(1!=a){e.next=22;break}c.loader=bn,c.embedded=!1,e.next=23;break;case 22:throw"unsupported format type";case 23:return e.abrupt("return",c);case 24:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Cn(e,t,r){var n=[];T(e,n),postMessage({type:"".concat(t,"_DATA"),resp:e,msg:"Success: "+r},n)}var zn,Fn="inputs",Pn="quality_control",In="normalizaton",Bn="feature_selecton",qn="pca",Kn="neighbor_index",Wn="tsne",Ln="umap",Jn="kmeans_cluster",Yn="snn_cluster_graph",Vn="choose_clustering",Hn="marker_detection",Xn="cell_labelling",Qn="custom_marker_management";function $n(e,t){return ea.apply(this,arguments)}function ea(){return(ea=(0,y.Z)(b().mark((function e(t,r){var n,a,s;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n="temp.h5",e.prev=1,s=_.ll(n),e.next=5,J(s,t,r);case 5:return pe(s),ke(s),Ze(s),We(s),tt(s),e.next=12,Wt(s);case 12:return e.next=14,sr(s);case 14:return wt(s),ft(s),Et(s),gr(s),e.next=20,Lr(s);case 20:en(s),a=_.pJ(n);case 22:return e.prev=22,_.ki(n)&&_.Yd(n),e.finish(22);case 25:return e.abrupt("return",a);case 26:case"end":return e.stop()}}),e,null,[[1,,22,25]])})))).apply(this,arguments)}function ta(e,t,r){return ra.apply(this,arguments)}function ra(){return(ra=(0,y.Z)(b().mark((function e(t,r,y){var g,w,S,x,k,G,D,M,E,N,O,T,A,U,Z,R;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return g=function(e,t,r){Cn(e.results(),t,r)},w=function(e,t,r){e.results().then((function(e){Cn(e,t,r)}))},S={},x=new _.pT(t),e.next=6,V(x,r,y);case 6:return k=e.sent,S.files={format:"kana",files:[]},g(n,Fn,"Reloaded count matrix"),G=ve(x),g(a,Pn,"Reloaded QC metrics"),S.qc={"qc-usemitodefault":G.use_mito_default,"qc-mito":G.mito_prefix,"qc-nmads":G.nmads},g(s,In,"Reloaded log-normalization"),D=je(x,k),g(o,Bn,"Reloaded variance modelling statistics"),S.fSelection={"fsel-span":D.span},M=Je(x),g(u,qn,"Reloaded principal components"),S.pca={"pca-hvg":M.num_hvgs,"pca-npc":M.num_pcs},E=rt(x),g(i,Kn,"Reloaded neighbor search index"),S.cluster={"clus-approx":E.approximate},N=Jt(x),w(p,Wn,"t-SNE reloaded"),S.tsne={"tsne-perp":N.perplexity,"tsne-iter":N.iterations,animate:N.animate},O=ur(x),w(m,Ln,"UMAP reloaded"),S.umap={"umap-epochs":O.num_epochs,"umap-nn":O.num_neighbors,"umap-min_dist":O.min_dist,animate:O.animate},T=xt(x),g(l,Jn,"K-means clustering reloaded"),S.cluster["kmeans-k"]=T.k,A=mt(x),g(c,Yn,"SNN graph clustering reloaded"),S.cluster["clus-k"]=A.k,S.cluster["clus-scheme"]=A.scheme,S.cluster["clus-res"]=A.resolution,U=Nt(x),g(f,Vn,"Clustering of interest chosen"),S.cluster["clus-method"]=U.method,wr(x,k),g(d,Hn,"Reloaded per-cluster markers"),Z=Yr(x),w(v,Xn,"Reloaded cell type labels"),S.annotateCells={"annotateCells-human_references":Z.human_references,"annotateCells-mouse_references":Z.mouse_references},R=nn(x,k),g(h,Qn,"Pruning of custom markers finished"),S["custom-selections"]=R,e.abrupt("return",S);case 49:case"end":return e.stop()}}),e)})))).apply(this,arguments)}onmessage=function(e){var t=e.data;if("INIT"==t.type){var r=Math.round(2*navigator.hardwareConcurrency/3),g=_.j2({numberOfThreads:r});g.then((function(e){postMessage({type:t.type,msg:"Success: ScranJS/WASM initialized"})}));var w=un=new Promise((function(e){(tn=indexedDB.open("KanaDB",2)).onupgradeneeded=function(e){var t=e.target.result;try{t.deleteObjectStore("analysis")}catch(e){}try{t.deleteObjectStore("analysis_meta")}catch(e){}try{t.deleteObjectStore("file")}catch(e){}try{t.deleteObjectStore("file_meta")}catch(e){}t.createObjectStore("analysis",{keyPath:"id"}),t.createObjectStore("analysis_meta",{keyPath:"id"}),t.createObjectStore("file",{keyPath:"id"}),t.createObjectStore("file_meta",{keyPath:"id"})},tn.onsuccess=function(){cn(e)},tn.onerror=function(){e(null)}}));w.then((function(e){null!==e?postMessage({type:"KanaDB_store",resp:e,msg:"Success"}):(console.error(error),postMessage({type:"KanaDB_ERROR",msg:"Fail: Cannot initialize DB"}))}));var S=zt(),x=Qt();zn=Promise.all([g,w,S,x])}else if("RUN"==t.type)zn.then((function(e){!function(e){var t=function(e,t,r){e.changed&&Cn(e.results(),t,r)},r=function(e,t,r){e.changed&&e.results().then((function(e){Cn(e,t,r)}))};W(e.files.format,e.files.files),t(n,Fn,"Count matrix loaded"),ie(e.params.qc["qc-usemitodefault"],e.params.qc["qc-mito"],e.params.qc["qc-nmads"]),t(a,Pn,"Applying quality control filters"),Se(),t(s,In,"Log-normalization completed"),Te(e.params.fSelection["fsel-span"]),t(o,Bn,"Variance modelling completed"),qe(e.params.pca["pca-hvg"],e.params.pca["pca-npc"]),t(u,qn,"Principal components analysis completed"),$e(e.params.cluster["clus-approx"]),t(i,Kn,"Neighbor search index constructed"),It(e.params.tsne["tsne-perp"],e.params.tsne["tsne-iter"],e.params.tsne.animate),r(p,Wn,"t-SNE completed"),tr(e.params.umap["umap-nn"],e.params.umap["umap-epochs"],e.params.umap["umap-min_dist"],e.params.umap.animate),r(m,Ln,"UMAP completed");var y=e.params.cluster["clus-method"];bt("kmeans"==y,e.params.cluster["kmeans-k"]),t(l,Jn,"K-means clustering completed"),ct("snn_graph"==y,e.params.cluster["clus-k"],e.params.cluster["clus-scheme"],e.params.cluster["clus-res"]),t(c,Yn,"SNN graph clustering completed"),Dt(e.params.cluster["clus-method"]),t(f,Vn,"Clustering of interest chosen"),hr(),t(d,Hn,"Marker detection complete"),qr(e.params.annotateCells["annotateCells-human_references"],e.params.annotateCells["annotateCells-mouse_references"]),r(v,Xn,"Cell type labelling complete"),Qr(),t(h,Qn,"Pruning of custom markers finished")}(t.payload)})).catch((function(e){console.error(e),postMessage({type:"run_ERROR",msg:e.toString()})}));else if("LOAD"==t.type){var k="temp.h5";if("kana"==t.payload.files.format){var G=t.payload.files.files.file[0];zn.then(function(){var e=(0,y.Z)(b().mark((function e(t){var r,n,a,s;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new FileReaderSync,n=r.readAsArrayBuffer(G),e.prev=2,e.next=5,Rn(n,k);case 5:return a=e.sent,e.next=8,ta(k,a.loader,a.embedded);case 8:s=e.sent,postMessage({type:"loadedParameters",resp:s});case 10:return e.prev=10,_.ki(k)&&_.Yd(k),e.finish(10);case 13:case"end":return e.stop()}}),e,null,[[2,,10,13]])})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error(e),postMessage({type:"load_ERROR",msg:e.toString()})}))}else if("kanadb"==t.payload.files.format){(function(e){return wn.apply(this,arguments)})(M=t.payload.files.files.file).then(function(){var e=(0,y.Z)(b().mark((function e(t){var r,n;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t){e.next=4;break}postMessage({type:"KanaDB_ERROR",msg:"Fail: cannot load analysis ID '".concat(M,"'")}),e.next=15;break;case 4:return e.prev=4,e.next=7,Rn(t,k);case 7:return r=e.sent,e.next=10,ta(k,r.loader,r.embedded);case 10:n=e.sent,postMessage({type:"loadedParameters",resp:n});case 12:return e.prev=12,_.ki(k)&&_.Yd(k),e.finish(12);case 15:case"end":return e.stop()}}),e,null,[[4,,12,15]])})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error(e),postMessage({type:"load_ERROR",msg:e.toString()})}))}}else if("EXPORT"==t.type)zn.then(function(){var e=(0,y.Z)(b().mark((function e(t){var r,n,a;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,On(!0);case 2:return r=e.sent,e.next=5,$n(r.saver,!0);case 5:return n=e.sent,e.next=8,An(n,r.collected);case 8:a=e.sent,postMessage({type:"exportState",resp:a,msg:"Success: application state exported"},[a]);case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error(e),postMessage({type:"export_ERROR",msg:e.toString()})}));else if("SAVEKDB"==t.type){var D=t.payload.title;zn.then(function(){var e=(0,y.Z)(b().mark((function e(t){var r,n,a;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,On(!1);case 2:return r=e.sent,e.next=5,$n(r.saver,!1);case 5:return n=e.sent,e.next=8,Un(n,r.collected,D);case 8:if(e.sent,null===M){e.next=16;break}return e.next=12,mn();case 12:a=e.sent,postMessage({type:"KanaDB_store",resp:a,msg:"Success: Saved analysis to cache (".concat(M,")")}),e.next=18;break;case 16:console.error(error),postMessage({type:"KanaDB_ERROR",msg:"Fail: Cannot save analysis to cache (".concat(M,")")});case 18:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error(e),postMessage({type:"export_ERROR",msg:e.toString()})}))}else if("REMOVEKDB"==t.type){var M;(function(e){return kn.apply(this,arguments)})(M=t.payload.id).then(function(){var e=(0,y.Z)(b().mark((function e(t){var r;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=7;break}return e.next=3,mn();case 3:r=e.sent,postMessage({type:"KanaDB_store",resp:r,msg:"Success: Removed file from cache (".concat(M,")")}),e.next=9;break;case 7:console.error(error),postMessage({type:"KanaDB_ERROR",msg:"fail: cannot remove file from cache (".concat(M,")")});case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())}else"getMarkersForCluster"==t.type?zn.then((function(e){var r=t.payload.cluster,n=Sr(t.payload.rank_type,r),a=[];T(n,a),postMessage({type:"setMarkersForCluster",resp:n,msg:"Success: GET_MARKER_GENE done"},a)})):"getGeneExpression"==t.type?zn.then((function(e){var r=t.payload.gene,n=Me(r);postMessage({type:"setGeneExpression",resp:{gene:r,expr:n},msg:"Success: GET_GENE_EXPRESSION done"},[n.buffer])})):"computeCustomMarkers"==t.type?zn.then((function(e){an(t.payload.id,t.payload.selection),postMessage({type:"computeCustomMarkers",msg:"Success: COMPUTE_CUSTOM_MARKERS done"})})):"getMarkersForSelection"==t.type?zn.then((function(e){var r=on(t.payload.cluster,t.payload.rank_type),n=[];T(r,n),postMessage({type:"setMarkersForCustomSelection",resp:r,msg:"Success: GET_MARKER_GENE done"},n)})):"removeCustomMarkers"==t.type?zn.then((function(e){sn(t.payload.id)})):"animateTSNE"==t.type?zn.then(function(){var e=(0,y.Z)(b().mark((function e(t){return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Yt();case 2:return e.next=4,Kt();case 4:Cn(e.sent,"tsne","Resending t-SNE coordinates");case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()):"animateUMAP"==t.type?zn.then(function(){var e=(0,y.Z)(b().mark((function e(t){return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ir();case 2:return e.next=4,ar();case 4:Cn(e.sent,"umap","Resending UMAP coordinates");case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()):"getAnnotation"==t.type?zn.then((function(e){var r=t.payload.annotation,n=ee(r);postMessage({type:"setAnnotation",resp:{annotation:r,values:{index:n.index,factor:n.factor}},msg:"Success: GET_ANNOTATION done"},[n.factor.buffer])})):console.error("MIM:::msg type incorrect")}}},t={};function r(n){var a=t[n];if(void 0!==a)return a.exports;var s=t[n]={exports:{}};return e[n](s,s.exports,r),s.exports}r.m=e,r.x=function(){var e=r.O(void 0,[275,555],(function(){return r(7794)}));return e=r.O(e)},function(){var e=[];r.O=function(t,n,a,s){if(!n){var o=1/0;for(l=0;l<e.length;l++){n=e[l][0],a=e[l][1],s=e[l][2];for(var u=!0,i=0;i<n.length;i++)(!1&s||o>=s)&&Object.keys(r.O).every((function(e){return r.O[e](n[i])}))?n.splice(i--,1):(u=!1,s<o&&(o=s));if(u){e.splice(l--,1);var c=a();void 0!==c&&(t=c)}}return t}s=s||0;for(var l=e.length;l>0&&e[l-1][2]>s;l--)e[l]=e[l-1];e[l]=[n,a,s]}}(),r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,{a:t}),t},r.d=function(e,t){for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.f={},r.e=function(e){return Promise.all(Object.keys(r.f).reduce((function(t,n){return r.f[n](e,t),t}),[]))},r.u=function(e){return"static/js/"+e+"."+{139:"648828a0",275:"a46fbc3b",495:"9608b3d0",555:"5b63638f",653:"983ac64d"}[e]+".chunk.js"},r.miniCssF=function(e){},r.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}(),r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.p="/kana/",function(){r.b=self.location+"/../../../";var e={794:1};r.f.i=function(t,n){e[t]||importScripts(r.p+r.u(t))};var t=self.webpackChunkkana=self.webpackChunkkana||[],n=t.push.bind(t);t.push=function(t){var a=t[0],s=t[1],o=t[2];for(var u in s)r.o(s,u)&&(r.m[u]=s[u]);for(o&&o(r);a.length;)e[a.pop()]=1;n(t)}}(),function(){var e=r.x;r.x=function(){return Promise.all([r.e(275),r.e(555)]).then(e)}}();r.x()}();
//# sourceMappingURL=794.2c0546ea.chunk.js.map